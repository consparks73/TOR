<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Outer Rim: A Star Wars Story</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Chakra+Petch:wght@400;700&family=Cinzel:wght@700&family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
    <style>
        html, body, #root {
            height: 100%;
            margin: 0;
            padding: 0;
        }
        body.game-active {
            overflow: hidden;
        }
        body {
            font-family: 'Chakra Petch', sans-serif;
            background-color: #111827; /* bg-gray-900 */
        }
        .font-title {
            font-family: 'Cinzel', serif;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            text-shadow: 3px 3px 4px #000;
        }
        .title-outline {
            text-shadow: -2px -2px 0 #000, 2px -2px 0 #000, -2px 2px 0 #000, 2px 2px 0 #000, 4px 4px 8px rgba(0,0,0,0.7);
        }
        .custom-scrollbar {
            scrollbar-width: thin;
            scrollbar-color: #f59e0b #111827;
        }
        .custom-scrollbar::-webkit-scrollbar {
            width: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #1f2937;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: #f59e0b; /* Amber */
            border-radius: 5px;
            border: 2px solid #1f2937;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background-color: #fbbf24; /* Lighter Amber */
        }
        .game-button, .game-select {
            transition: all 0.2s ease-in-out;
        }
        .game-button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0, 255, 255, 0.2);
        }
        .game-button:disabled, .game-select:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: translateY(0);
            box-shadow: none;
        }
        .interactive-tab-button.active {
            background-color: #ca8a04; /* yellow-600 */
            color: white;
        }
        .stat-bonus-indicator {
            transition: opacity 0.3s;
        }
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid #f59e0b;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        
        .game-grid {
             display: grid;
             grid-template-columns: 1fr 1fr;
             grid-template-rows: 1fr 1fr;
             height: 100vh;
             background-color: #030712; /* gray-950 */
        }
        .grid-quadrant {
             border: 1px solid #374151; /* gray-700 */
        }

        /* --- Quest Log & Interactive Panel Styles --- */
        .interactive-list-item {
            padding: 0.5rem 0.75rem;
            cursor: pointer;
            border-bottom: 1px solid #374151;
            transition: background-color 0.2s;
        }
        .interactive-list-item:hover {
            background-color: #374151;
        }
        .interactive-list-item.selected {
            background-color: #4b5563;
            border-left: 3px solid #f59e0b;
        }
        .quest-log-section summary {
            cursor: pointer;
            padding: 8px;
            background-color: #374151;
            border-radius: 4px;
            font-weight: bold;
            color: #f59e0b;
            margin-top: 8px;
            outline: none;
            transition: background-color 0.2s;
        }
        .quest-log-section summary:hover {
            background-color: #4b5563;
        }
        .quest-log-section[open] summary {
            border-bottom-left-radius: 0;
            border-bottom-right-radius: 0;
        }
        .quest-log-section .quest-content {
            padding: 8px;
            background-color: #1f2937;
            border: 1px solid #374151;
            border-top: none;
            border-radius: 0 0 4px 4px;
        }


        /* --- Sabacc Modal Styles --- */
        .sabacc-modal-backdrop {
            position: fixed;
            inset: 0;
            background-color: rgba(0,0,0,0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
            animation: fadeIn 0.3s ease-out;
        }
        .sabacc-modal-content {
            background: radial-gradient(ellipse at center, #6b4f3b 0%, #4a3627 100%);
            border: 2px solid #b99573;
            border-radius: 30% / 50%;
            padding: 24px;
            width: 95%;
            max-width: 700px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5), inset 0 0 15px rgba(0,0,0,0.5);
            color: #dad7cd;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        .sabacc-hand-area {
            display: flex;
            justify-content: center;
            gap: 10px;
            height: 90px;
            position: relative;
        }
        .sabacc-card-slot {
            width: 70px;
            height: 80px;
            background-color: #2a1f18;
            clip-path: polygon(50% 0%, 100% 25%, 100% 75%, 50% 100%, 0% 75%, 0% 25%);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .sabacc-card {
            width: 64px;
            height: 74px;
            background-color: #3d4551;
            border: 1px solid #9ca3af;
            color: #fff;
            clip-path: polygon(50% 0%, 100% 25%, 100% 75%, 50% 100%, 0% 75%, 0% 25%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.5rem;
            font-family: 'Orbitron', sans-serif;
            text-shadow: 1px 1px 2px #000;
        }
        .sabacc-card.hidden {
            background-color: #9a2a2a;
            color: transparent;
            border-color: #ff5555;
        }
        .sabacc-pot-display {
            background-color: #2c3e50;
            border: 3px solid #7f8c8d;
            border-radius: 4px;
            padding: 8px;
            text-align: center;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
            width: 250px;
            margin: 0 auto;
        }
        .sabacc-pot-display .pot-label {
            font-family: 'Orbitron', sans-serif;
            font-weight: bold;
            color: #e67e22;
            font-size: 0.8rem;
            letter-spacing: 0.1em;
        }
        .sabacc-pot-display .pot-amount {
            font-size: 1.5rem;
            font-weight: bold;
            color: #f1c40f;
        }
        .sabacc-message {
            font-size: 0.9rem;
            color: #3498db;
            min-height: 20px;
        }
        .sabacc-hand-label {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            font-family: 'Orbitron', sans-serif;
            font-size: 0.8rem;
            padding: 2px 8px;
            border-radius: 4px;
            background-color: rgba(0,0,0,0.5);
            z-index: 10;
        }
        .sabacc-hand-label.dealer {
            top: -10px;
            color: #bdc3c7;
        }
        .sabacc-hand-label.player {
            bottom: -10px;
            color: #f1c40f;
        }

        /* --- Combat Modal Styles --- */
        .combat-modal-backdrop {
            position: absolute;
            inset: 0;
            background-color: rgba(0,0,0,0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 40;
            animation: fadeIn 0.5s ease-out;
        }
        .combat-modal-content {
            position: relative;
            width: 95%;
            max-width: 800px;
            height: 450px;
            background-color: #111827;
            border: 2px solid #ef4444; /* red-500 */
            box-shadow: 0 0 30px rgba(239, 68, 68, 0.4);
            border-radius: 8px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        .combat-background {
            position: absolute;
            inset: 0;
            width: 100%;
            height: 100%;
            background-color: #111827;
            z-index: 1;
        }
        .combat-vignette {
            position: absolute;
            inset: 0;
            box-shadow: inset 0 0 100px 50px rgba(0,0,0,0.8);
            z-index: 2;
        }
        .combat-action-bar {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 80px;
            background-color: rgba(17, 24, 39, 0.9); /* bg-gray-900 with opacity */
            border-top: 2px solid #ef4444;
            z-index: 4;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 1rem;
            padding: 0 1rem;
        }
        .combat-status-display {
            position: absolute;
            z-index: 3;
            background-color: rgba(0,0,0,0.7);
            padding: 8px;
            border-radius: 6px;
            border: 1px solid #4b5563; /* gray-600 */
            min-width: 200px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.5);
            transition: box-shadow 0.2s ease-in-out, transform 0.2s ease-in-out;
            animation-duration: 0.3s;
            animation-timing-function: ease-in-out;
        }
        .combat-status-display.active-turn {
            box-shadow: 0 0 15px 5px rgba(251, 191, 36, 0.6); /* Amber glow */
            transform: scale(1.03);
        }
        .combat-status-display.player {
            bottom: 90px;
            left: 10px;
        }
        .combat-status-display.companion {
            bottom: 90px;
            left: 220px;
        }
        .combat-status-display.enemy {
            top: 10px;
            right: 10px;
        }
        .blinking-cursor {
            animation: blink 1s step-end infinite;
        }
        .damage-popup {
            position: absolute;
            font-size: 1.5rem;
            font-weight: bold;
            color: #ef4444; /* red-500 */
            text-shadow: 1px 1px 2px #000;
            animation: moveUpAndFade 1.5s forwards;
            pointer-events: none;
        }
        .damage-popup.crit {
            font-size: 2.2rem;
            color: #f59e0b; /* amber-500 */
        }
        
        .screen-flash {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: white;
            opacity: 0;
            z-index: 100;
            pointer-events: none;
            animation: flash 0.4s ease-out;
        }

        /* --- Vendor Modal Styles --- */
        .vendor-modal-backdrop {
            position: fixed;
            inset: 0;
            background-color: rgba(0,0,0,0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
            animation: fadeIn 0.3s ease-out;
        }
        .vendor-modal-content {
            width: 95%;
            max-width: 900px;
            height: 600px;
            background-color: #1f2937;
            border: 2px solid #f59e0b;
            border-radius: 8px;
            box-shadow: 0 0 30px rgba(245, 158, 11, 0.3);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }
        .vendor-background {
            position: absolute;
            inset: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            opacity: 0.2;
            z-index: 0;
        }
        .vendor-header {
            position: relative;
            padding: 1rem;
            border-bottom: 2px solid #f59e0b;
            background: linear-gradient(to bottom, rgba(17, 24, 39, 0.9), rgba(17, 24, 39, 0.7));
            text-align: center;
        }
        .vendor-main {
            position: relative;
            flex-grow: 1;
            display: flex;
            min-height: 0;
        }
        .vendor-item-list {
            width: 40%;
            border-right: 1px solid #4b5563;
            display: flex;
            flex-direction: column;
        }
        .vendor-item-detail {
            width: 60%;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        .vendor-tabs {
            display: flex;
            border-bottom: 1px solid #4b5563;
        }
        .vendor-tab {
            flex-grow: 1;
            padding: 0.75rem 0;
            text-align: center;
            background-color: #375151;
            cursor: pointer;
            border-bottom: 3px solid transparent;
        }
        .vendor-tab.active {
            background-color: #1f2937;
            color: #f59e0b;
            border-bottom-color: #f59e0b;
        }
        .vendor-item-list-content {
            flex-grow: 1;
            overflow-y: auto;
        }
        .vendor-item-entry {
            padding: 0.75rem;
            cursor: pointer;
            border-bottom: 1px solid #374151;
            display: flex;
            justify-content: space-between;
        }
        .vendor-item-entry:hover, .vendor-item-entry.selected {
            background-color: #4b5563;
        }
        .vendor-item-entry.cant-afford {
            color: #9ca3af;
            cursor: not-allowed;
        }
        
        /* --- Command Input & Log --- */
        #log-box {
            position: relative;
        }
        #log-history {
            flex-grow: 1;
            overflow-y: auto;
            padding-right: 10px; /* space for scrollbar */
        }
        #command-form {
            display: flex;
            align-items: center;
            border-top: 1px solid #374151;
            padding-top: 8px;
            margin-top: 8px;
            flex-shrink: 0;
        }
        #command-input {
            background: transparent;
            border: none;
            outline: none;
            color: #fde047; /* yellow-300 */
            width: 100%;
            font-family: 'Chakra Petch', sans-serif;
            font-size: 1rem;
        }
        .skip-indicator {
            position: absolute;
            bottom: 48px; /* Above the command input */
            right: 12px;
            font-size: 0.75rem;
            color: #6b7280; /* gray-500 */
            animation: pulse-subtle 2s infinite ease-in-out;
            pointer-events: none;
        }

        /* --- Dialogue Modal --- */
        .dialogue-modal-backdrop {
            position: fixed;
            inset: 0;
            background-color: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 60;
            animation: fadeIn 0.3s ease-out;
        }
        .dialogue-modal-content {
            background-color: #1f2937;
            border: 2px solid #60a5fa; /* blue-400 */
            border-radius: 8px;
            width: 95%;
            max-width: 900px;
            height: 400px;
            box-shadow: 0 0 30px rgba(96, 165, 250, 0.4);
            display: flex;
            overflow: hidden;
        }
        .dialogue-portrait-container {
            width: 300px;
            flex-shrink: 0;
            background-color: #111827;
            display: flex;
            align-items: center;
            justify-content: center;
            border-right: 2px solid #60a5fa;
        }
        .dialogue-portrait-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .dialogue-main {
            flex-grow: 1;
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            position: relative;
        }
        #dialogue-npc-text {
            flex-grow: 1;
            overflow-y: auto;
            font-size: 1.1rem;
        }
        #dialogue-choices {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #374151;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            max-height: 150px;
            overflow-y: auto;
        }
        .dialogue-choice-button {
            background-color: #374151;
            padding: 0.75rem;
            border-radius: 4px;
            text-align: left;
            transition: background-color 0.2s;
            cursor: pointer;
            width: 100%;
            border: none;
            color: #e5e7eb; /* gray-200 */
        }
        .dialogue-choice-button:hover {
            background-color: #4b5563;
        }
        .dialogue-main .skip-indicator {
            bottom: 175px; /* Above the choices */
        }

        /* --- HoloNet Modal Styles --- */
        .holonet-modal-backdrop {
            position: fixed;
            inset: 0;
            background-color: rgba(0,0,0,0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
            animation: fadeIn 0.3s ease-out;
        }
        .holonet-modal-content {
            width: 95%;
            max-width: 900px;
            height: 600px;
            background-color: #0c1421;
            border: 2px solid #0ea5e9; /* sky-500 */
            border-radius: 8px;
            box-shadow: 0 0 30px rgba(14, 165, 233, 0.4), inset 0 0 15px rgba(14, 165, 233, 0.2);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
            font-family: 'Orbitron', sans-serif;
        }
        .holonet-header {
            position: relative;
            padding: 1rem;
            border-bottom: 2px solid #0ea5e9;
            background: linear-gradient(to bottom, rgba(12, 74, 110, 0.9), rgba(3, 7, 18, 0.8));
            text-align: center;
        }
        .holonet-main {
            flex-grow: 1;
            display: flex;
            min-height: 0;
        }
        .holonet-story-list {
            width: 40%;
            border-right: 1px solid #0c4a6e; /* cyan-800 */
            overflow-y: auto;
            background-color: rgba(3, 7, 18, 0.5);
        }
        .holonet-story-detail {
            width: 60%;
            padding: 1.5rem;
            overflow-y: auto;
            color: #bae6fd; /* sky-200 */
        }
        .holonet-story-entry {
            padding: 1rem;
            cursor: pointer;
            border-bottom: 1px solid #0c4a6e;
            transition: background-color 0.2s;
        }
        .holonet-story-entry:hover, .holonet-story-entry.selected {
            background-color: #075985; /* sky-700 */
        }

        /* --- Character Creator & Level Up--- */
        .creator-choice-box {
            background-color: #1f2937; /* gray-800 */
            border: 2px solid #374151; /* gray-700 */
            padding: 1rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        .creator-choice-box:hover {
            border-color: #f59e0b; /* amber-500 */
            transform: translateY(-3px);
        }
        .creator-choice-box.selected {
            border-color: #60a5fa; /* blue-400 */
            box-shadow: 0 0 15px rgba(96, 165, 250, 0.5);
            background-color: #374151;
        }
        .bonus-display {
            margin-top: auto;
            padding-top: 0.5rem;
            border-top: 1px solid #4b5563;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes blink {
            from, to { color: transparent; }
            50% { color: inherit; }
        }
        .animate-fade-in {
            animation: fadeIn 1.5s ease-in-out;
        }
        @keyframes textFadeIn {
            0% { opacity: 0; }
            40% { opacity: 0; }
            100% { opacity: 1; }
        }
        .cutscene-text-fade {
            animation: textFadeIn 2.5s ease-in-out forwards;
        }
        @keyframes moveUpAndFade {
            0% {
                transform: translateY(0) scale(1);
                opacity: 1;
            }
            100% {
                transform: translateY(-50px) scale(1.2);
                opacity: 0;
            }
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            50% { transform: translateX(5px); }
            75% { transform: translateX(-5px); }
        }
        .shake-animation {
            animation-name: shake;
        }
        @keyframes flash {
            0% { opacity: 0.7; }
            100% { opacity: 0; }
        }
        .level-up-button-glow {
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0%, 100% {
                box-shadow: 0 0 15px rgba(251, 191, 36, 0.6);
            }
            50% {
                box-shadow: 0 0 30px rgba(251, 191, 36, 1);
            }
        }
        @keyframes pulse-subtle {
            0%, 100% { opacity: 0.5; }
            50% { opacity: 1; }
        }

    </style>
<script type="importmap">
{
  "imports": {
    "@google/genai": "https://aistudiocdn.com/@google/genai@^1.26.0"
  }
}
</script>
<link rel="stylesheet" href="/index.css">
</head>
<body class="bg-gray-900 text-gray-200">
    <div id="root"></div>
    <script id="embedded-save-data" type="application/json"></script>

    <script type="module">
        import { GoogleGenAI, Modality } from "@google/genai";

        // --- DATA ---
        const nameData = {
            first: ["Kael", "Jax", "Zane", "Rylo", "Dash", "Talon", "Corran", "Fenn", "Jyn", "Kyra", "Saren", "Vette", "Mara", "Ayla", "Shay"],
            last: ["Vorr", "Stark", "Rendar", "Ordo", "Kenobi", "Shan", "Rook", "Shysa", "Erso", "Nym", "Kestis", "Zol", "Jade", "Ayla", "Vizla"]
        };
        const gameTips = [
            "S.P.E.C.I.A.L. stats are key to unlocking unique dialogue options and succeeding in skill checks.",
            "Always carry a Medpac. You never know when a deal will go sour on the Outer Rim.",
            "Talk to everyone. Wretched hives of scum and villainy are also hives of information.",
            "Check a vendor's inventory carefully. Sometimes they have rare parts or powerful weapon mods.",
            "Your background and faction choices can open up unique opportunities and dialogue.",
            "Don't be afraid to flee from a fight you can't win. Discretion is the better part of valor.",
            "A high Charisma can often get you out of trouble that a blaster can't.",
            "Remember to spend your attribute points when you level up to grow stronger!",
            "Exploring side areas can lead to valuable loot and interesting side quests.",
            "Some places and people only come out at night. Try resting at a safehouse to see how the world changes."
        ];
        const cutscene = [
            { text: "The year is 2 BBY. The Galactic Civil War rages. The iron fist of the Empire grips the galaxy, but sparks of rebellion are igniting in the darkest corners.", imagePrompt: "A vast starfield with an Imperial Star Destroyer looming over a desert planet. A small, rusty freighter tries to evade its patrol. Epic, cinematic, Star Wars style.", imageUrl: null },
            { text: "On the forgotten desert world of Tatooine, in the wretched hive of Mos Eisley, your story begins...", imagePrompt: "The sprawling, dusty city of Mos Eisley on Tatooine at dusk, twin suns setting in the background. A few landspeeders kick up dust. Cinematic, detailed, Star Wars universe.", imageUrl: null },
            { text: "You carry a secret—a datapad with encrypted information that could change the fate of the galaxy. But the memory of how you got it is a fractured nightmare.", imagePrompt: "A first-person view of hands holding a futuristic datapad that is glowing with encrypted symbols. The background is a blur of neon lights and shadows. Tense, mysterious, high detail.", imageUrl: null },
            { text: "You must find a way to unlock its secrets before the Empire finds you. It all begins here.", imagePrompt: "A hooded figure sits in a shadowy corner of the Mos Eisley cantina. Their face is hidden in darkness, illuminated only by the faint, upward glow from a high-tech datapad they hold. The datapad's screen is filled with complex, glowing Aurebesh characters. Cinematic, mysterious, noir, Star Wars aesthetic.", imageUrl: null },
            { text: '', isTitleSlide: true, imagePrompt: "A breathtaking, panoramic shot overlooking the entire sprawling city of Mos Eisley on Tatooine. The iconic binary sunset, with two suns setting, bathes the desert landscape in warm orange and purple hues. Cinematic, epic, high detail, Star Wars.", imageUrl: null }
        ];
        const AllStats = ['S', 'P', 'E', 'C', 'I', 'A', 'L'];
        const specialNames = { S: "Strength", P: "Perception", E: "Endurance", C: "Charisma", I: "Intelligence", A: "Agility", L: "Luck" };
        const classes = {
            bounty_hunter: {
                name: 'Bounty Hunter',
                description: 'A skilled tracker and warrior, adept with various weapons and gadgets. Feared and respected across the galaxy.',
                statBonuses: { P: 2, A: 1 },
                startItem: 'blaster_pistol'
            },
            scoundrel: {
                name: 'Scoundrel',
                description: 'A charming rogue who lives by their wits and a fast trigger finger. Excels at talking their way in or out of trouble.',
                statBonuses: { C: 2, L: 1 },
                startItem: 'credits_pouch'
            },
            force_sensitive: {
                name: 'Force-Sensitive Exile',
                description: 'Hiding from the Empire, you possess a rare connection to the Force, granting you abilities others can only dream of.',
                statBonuses: { I: 2, E: 1 },
                startItem: 'training_lightsaber'
            }
        };
         const backgrounds = {
            imperial_defector: {
                name: 'Imperial Defector',
                description: 'You saw the truth behind the Empire\'s order and escaped. Your knowledge of their protocols is a valuable, and dangerous, asset.',
                bonus: { type: 'stat', stat: 'I', value: 1 }
            },
            corporate_drone: {
                name: 'Corporate Drone',
                description: 'You were a cog in the machine of a powerful corporation. You know how to navigate bureaucracy and grease the right palms.',
                bonus: { type: 'credits', value: 150 }
            },
            wasteland_scavenger: {
                name: 'Wasteland Scavenger',
                description: 'You grew up sifting through the galaxy\'s garbage. You can find value where others only see junk.',
                bonus: { type: 'stat', stat: 'L', value: 1 }
            }
        };
        const subclasses = {
            bounty_hunter: {
                marksman: { name: 'Marksman', description: 'Focuses on precision and ranged superiority.', bonus: { P: 1 } },
                gadgeteer: { name: 'Gadgeteer', description: 'Uses technology and explosives to control the battlefield.', bonus: { I: 1 } }
            },
            scoundrel: {
                gunslinger: { name: 'Gunslinger', description: 'Relies on speed and a fast trigger finger.', bonus: { A: 1 } },
                infiltrator: { name: 'Infiltrator', description: 'Master of stealth and deception.', bonus: { C: 1 } }
            },
            force_sensitive: {
                sentinel: { name: 'Sentinel', description: 'Balances the Force with practical skills, a guardian of the forgotten.', bonus: { E: 1 } },
                consular: { name: 'Consular', description: 'Uses the Force to influence minds and see the unseen.', bonus: { C: 1 } }
            }
        };
        const races = {
            human: { name: 'Human', description: 'Ubiquitous and adaptable, humans can be found in every corner of the galaxy, in every profession.', bonus: { L: 1 } },
            twilek: { name: 'Twi\'lek', description: 'Known for their cunning and grace, Twi\'leks are often found in positions of power or performance, their head-tails (Lekku) aiding in communication.', bonus: { C: 1 } },
            zabrak: { name: 'Zabrak', description: 'A proud and resilient species from Iridonia, Zabraks possess a formidable willpower and are known for their independence.', bonus: { E: 1 } },
            rodian: { name: 'Rodian', description: 'Hailing from a jungle world, Rodians are natural hunters with large, multifaceted eyes and a reputation for violence.', bonus: { P: 1 } },
            mirialan: { name: 'Mirialan', description: 'A deeply spiritual and disciplined species, Mirialans believe their actions in life contribute to their destiny. They are often skilled and focused individuals.', bonus: { I: 1 } },
            wookiee: { name: 'Wookiee', description: 'Known for their immense strength and unwavering loyalty, Wookiees are a formidable presence in any fight.', bonus: { S: 1 } },
            trandoshan: { name: 'Trandoshan', description: 'A reptilian species of cold-blooded hunters who value strength and the thrill of the hunt above all.', bonus: { E: 1 } },
            bothan: { name: 'Bothan', description: 'Masters of espionage and information gathering, the Bothan spynet is legendary. They are naturally cunning and persuasive.', bonus: { C: 1 } },
            chiss: { name: 'Chiss', description: 'A calculating and disciplined species from the Unknown Regions, known for their tactical brilliance and piercing red eyes.', bonus: { P: 1 } },
            mon_calamari: { name: 'Mon Calamari', description: 'Amphibious and methodical, Mon Calamari are renowned shipbuilders and brilliant military strategists.', bonus: { I: 1 } }
        };
        const factions = {
            empire: { 
                name: 'Galactic Empire', 
                description: 'The ruling power of the galaxy, born from the ashes of the Old Republic. The Empire maintains order through fear and overwhelming military might, crushing any dissent with its legions of stormtroopers and fleet of Star Destroyers.',
                bonus_desc: 'You know how Imperials think, giving you an edge in combat and dialogue against them.' 
            },
            hutt_cartel: { 
                name: 'Hutt Cartel', 
                description: 'A powerful criminal syndicate led by the ancient and gluttonous Hutts. From their palace on Tatooine, they control vast smuggling, slavery, and spice-running operations across the Outer Rim, a shadow government that even the Empire hesitates to cross.',
                bonus_desc: 'You understand the convoluted politics of the Hutts, granting a bonus to negotiation with underworld figures.' 
            },
            crimson_dawn: { 
                name: 'Crimson Dawn Syndicate',
                description: 'A ruthless and sophisticated crime syndicate that rose to power during the Clone Wars. Known for their public face of legitimacy and their brutal underworld dealings, they are a major player in the galactic criminal landscape, feared for their efficiency and reach.',
                bonus_desc: 'Your history with this crime syndicate gives you a bonus to intimidation checks against its members.' 
            }
        };
        const items = {
            // Quest
            'datapad': { id: 'datapad', name: 'Encrypted Datapad', description: 'A personal datapad, locked with heavy military-grade encryption from the Clone Wars era. It feels dangerously important, a relic of a past that could shatter the present.', value: 0, type: 'quest' },
            'bounty_license': { id: 'bounty_license', name: 'Bounty Hunter\'s License', description: 'An official license from the Bounty Hunters\' Guild, a tradition stretching back to the Old Republic. It allows you to legally accept and complete bounties, marking you as a professional in a dangerous trade.', value: 1000, type: 'quest' },
            'jawa_juice': { id: 'jawa_juice', name: 'Jawa Juice', description: 'A foul-smelling, but reportedly potent, beverage popular in the Outer Rim. Brewed from the mashed guts of banthas and other secret ingredients, it\'s an acquired taste.', value: 10, type: 'consumable' },
            'vex_intel': { id: 'vex_intel', name: 'Vex\'s Info Shard', description: 'A small, encrypted data shard containing information about hidden smuggling routes. Highly valuable to the right people.', value: 1500, type: 'quest' },
            'imperial_code_cylinder': { id: 'imperial_code_cylinder', name: 'Imperial Code Cylinder', description: 'A senior officer\'s code cylinder. The data is heavily fragmented, but contains partial coordinates to a location in the Outer Rim.', value: 0, type: 'quest' },

            // Currency
            'credits_pouch': { id: 'credits_pouch', name: 'Pouch of Credits', description: 'A small boost to your starting funds. In the Outer Rim, credits can buy you a ship, a drink, or a few more seconds of life.', value: 250, type: 'currency' },

            // Weapons
            'blaster_pistol': { id: 'blaster_pistol', name: 'Blaster Pistol (DL-18)', description: 'A reliable, standard-issue DL-18 sidearm. Common among smugglers and bounty hunters, it\'s a trusty tool for negotiations that have gone sour.', value: 250, type: 'weapon', slot: 'weapon', bonus: { S: 1 } },
            'training_lightsaber': { id: 'training_lightsaber', name: 'Training Lightsaber', description: 'A low-powered lightsaber, used by Jedi Initiates before they construct their own. In the age of the Empire, even this dull blade is a symbol of rebellion and a death sentence if discovered.', value: 100, type: 'weapon', slot: 'weapon', bonus: { A: 1 } },
            'vibroknife': { id: 'vibroknife', name: 'Vibroknife', description: 'A standard-issue combat knife that uses ultrasonic vibrations to enhance its cutting edge. A quiet and deadly alternative to a blaster.', value: 150, type: 'weapon', slot: 'weapon', bonus: { S: 2 } },
            'heavy_blaster_pistol': { id: 'heavy_blaster_pistol', name: 'Heavy Blaster (DL-44)', description: 'A powerful and famously reliable blaster pistol, known for its stopping power. A favorite of scoundrels and rebels alike.', value: 750, type: 'weapon', slot: 'weapon', bonus: { S: 3 } },
            
            // Armor
            'scavenged_armor_jacket': { id: 'scavenged_armor_jacket', name: 'Scavenged Armor Jacket', description: 'A worn leather jacket reinforced with scavenged plastoid plates. Offers minimal protection but is better than nothing.', value: 200, type: 'armor', slot: 'armor', bonus: { defense: 1 } },
            'bounty_hunter_armor': { id: 'bounty_hunter_armor', name: 'Bounty Hunter Armor', description: 'A set of durasteel armor plating worn over a flight suit. Provides decent protection against blaster fire and physical attacks.', value: 1200, type: 'armor', slot: 'armor', bonus: { defense: 3 } },
            
            // Gear
            'macrobinoculars': { id: 'macrobinoculars', name: 'Macrobinoculars', description: 'A pair of high-powered binoculars with multiple vision modes, including thermal and night vision. Essential for any scout or hunter.', value: 300, type: 'gear', slot: 'gear', bonus: { P: 1 } },
            'jetpack_booster': { id: 'jetpack_booster', name: 'Jetpack Booster', description: 'A small, single-use rocket booster that can provide a short burst of flight. Useful for reaching high places or making a quick escape.', value: 500, type: 'gear', slot: 'gear', bonus: { A: 1 } },

            // Consumables
            'medpac': { id: 'medpac', name: 'Medpac', description: 'A single-use medical kit containing bacta spray and synth-flesh bandages. Heals 25 HP.', value: 50, type: 'consumable', effect: { type: 'heal', amount: 25 } },
            'stimpak': { id: 'stimpak', name: 'Stimpak', description: 'A military-grade stimulant that provides a temporary boost in combat. Increases Strength by 2 for the duration of one fight.', value: 100, type: 'consumable', effect: { type: 'buff', stat: 'S', amount: 2, duration: 'combat' } },
            'combat_adrenal': { id: 'combat_adrenal', name: 'Combat Adrenal', description: 'A potent chemical cocktail that heightens reflexes and deadens pain. Increases Agility by 2 for the duration of one fight.', value: 100, type: 'consumable', effect: { type: 'buff', stat: 'A', amount: 2, duration: 'combat' } },
            'bacta_shot': { id: 'bacta_shot', name: 'Bacta Shot', description: 'A concentrated injection of pure bacta. A miraculous healing agent that can mend even serious wounds. Heals 75 HP.', value: 200, type: 'consumable', effect: { type: 'heal', amount: 75 } },
            'thermal_detonator': { id: 'thermal_detonator', name: 'Thermal Detonator', description: 'A highly illegal and extremely powerful grenade. Use with extreme caution. Deals significant damage to an enemy in combat.', value: 400, type: 'consumable', effect: { type: 'damage', amount: 50 } },
            'repair_kit': { id: 'repair_kit', name: 'Repair Kit', description: 'A set of tools for repairing droids and machinery. Might have other uses for a clever technician.', value: 120, type: 'consumable' },
            'ration_pack': { id: 'ration_pack', name: 'Ration Pack', description: 'A bland but nutritious meal pack, standard issue for soldiers and long-haul pilots.', value: 15, type: 'consumable' },
            'spice_vial': { id: 'spice_vial', name: 'Vial of Ryll Spice', description: 'A small vial containing refined Ryll spice from Ryloth. Highly illegal but valuable on the black market.', value: 250, type: 'consumable' },
            'roasted_porg_leg': { id: 'roasted_porg_leg', name: 'Roasted Porg Leg', description: 'Greasy, but filling. A common street food. Heals 15 HP.', value: 25, type: 'consumable', effect: { type: 'heal', amount: 15 } },
            'blue_milk_canteen': { id: 'blue_milk_canteen', name: 'Canteen of Blue Milk', description: 'Cool and refreshing Bantha milk. Heals 30 HP.', value: 40, type: 'consumable', effect: { type: 'heal', amount: 30 } },
        };
        const npcs = {
            'wuher': {
                id: 'wuher',
                name: 'Wuher',
                description: 'The gruff human bartender, constantly cleaning a glass with a dirty rag. He looks like he\'s seen everything, and is tired of all of it.',
                portraitPrompt: "A head and shoulders portrait of Wuher, the gruff human bartender from the Mos Eisley cantina. He has a receding hairline, a thick mustache, and weary, cynical eyes. He's wearing a simple, slightly stained cantina tunic. The lighting is dim and atmospheric, like the inside of a shadowy bar. Cinematic character concept art.",
                dialogueQuestChecks: [
                    { questId: 'a_foot_in_the_door', activeNode: 'quest_active', completedNode: 'post_quest' }
                ],
                dialogue: {
                    'start': {
                        npcText: "What do you want? We don't serve droids... or trouble.",
                        playerChoices: [
                            { text: "I'm looking for information.", leadsTo: 'information' },
                            { text: "What's your opinion on the Empire?", leadsTo: 'ask_lore_empire' },
                            { text: "Just a drink for now.", leadsTo: 'drink' }
                        ],
                        reactions: [
                            { condition: { type: 'playerClass', class: 'scoundrel' }, npcText: "I can smell a scoundrel a parsec away. Don't start anything." },
                            { condition: { type: 'hasItem', itemId: 'training_lightsaber' }, npcText: "Is that... what I think it is? You'd better keep that hidden. The Empire isn't kind to your type." }
                        ]
                    },
                    'ask_lore_empire': {
                        npcText: "The Empire? They're a blaster burn on the backside of the galaxy. They bring patrols, taxes, and trouble. Bad for business. But they pay in real credits, unlike some... so I serve them. Now, you want a drink or are you just here to stir up a hive of gundarks?",
                        playerChoices: [
                            { text: "I need some information.", leadsTo: 'information' },
                            { text: "I'll take a drink.", leadsTo: 'drink' },
                            { text: "[Leave] Nevermind.", leadsTo: 'end' }
                        ]
                    },
                    'drink': {
                        npcText: "Fine. One Corellian Ale. Now stop staring and drink up.",
                        playerChoices: [
                            { text: "Actually, I need some information.", leadsTo: 'information' },
                            { text: "[Leave] Thanks for the drink.", leadsTo: 'end' }
                        ]
                    },
                    'information': {
                        npcText: "Information costs. I'm thirsty, and my throat is parched. I could really go for some of that Jawa Juice from the bazaar.",
                        playerChoices: [
                            { text: "I'll get your juice.", action: { type: 'startQuest', questId: 'a_foot_in_the_door' }, leadsTo: 'quest_accepted' },
                            { text: "[Leave] I'm not an errand runner.", leadsTo: 'end' }
                        ]
                    },
                    'quest_accepted': {
                        npcText: "Good. Don't take too long. My throat's getting drier by the second.",
                        playerChoices: [ { text: "[Leave] I'll be back soon.", leadsTo: 'end' } ]
                    },
                    'quest_active': {
                        npcText: "You got my juice yet? The bazaar isn't that far.",
                         playerChoices: [
                            { 
                                text: "(Give Jawa Juice)", 
                                condition: { type: 'hasItem', itemId: 'jawa_juice' }, 
                                action: { 
                                    type: 'multi', 
                                    actions: [
                                        { type: 'completeQuestStage', questId: 'a_foot_in_the_door', stage: 1 },
                                        { type: 'removeItem', itemId: 'jawa_juice' }
                                    ]
                                },
                                leadsTo: 'give_info' 
                            },
                            { text: "[Leave] I'm still working on it.", leadsTo: 'end' }
                        ]
                    },
                    'give_info': {
                        npcText: "*He downs the juice in one gulp, shuddering.* Vile stuff. But it works. Alright, you kept your end. You need info, talk to the Rodian in the corner booth, Greedo. He hears things. But be warned, he's got a big mouth and a fast trigger finger. Now, scram.",
                        playerChoices: [ { text: "[Leave] Thanks for the tip.", action: { type: 'addNpc', npcId: 'greedo', locationId: 'mos_eisley_cantina' }, leadsTo: 'end' } ]
                    },
                    'post_quest': {
                        npcText: "Did you talk to Greedo? Good. Now, unless you're buying, move along.",
                        playerChoices: [ { text: "[Leave] I'm going.", leadsTo: 'end' } ]
                    },
                    'end': null
                }
            },
            'guild_admin': {
                id: 'guild_admin',
                name: 'Guild Administrator',
                description: 'A stoic, cybernetically-enhanced Twi\'lek sits behind a reinforced desk. Her lekku are wrapped neatly, and her eyes, cold and calculating, scan you, judging your worth as a hunter.',
                portraitPrompt: "A head and shoulders portrait of a stoic female Twi'lek bounty hunters' guild administrator. Her skin is a cool blue or green tone. She has subtle cybernetic enhancements around one eye. Her two head-tails (lekku) are wrapped in leather bindings. She has a cold, calculating expression. Lighting is sharp and professional, with a hint of shadow. Cinematic character concept art.",
                dialogue: {
                     'start': {
                        npcText: "State your business. This is the Bounty Hunters' Guild, not a social club.",
                        playerChoices: [
                            { text: "I'm here for work.", leadsTo: 'check_license' },
                            { text: "Tell me about the Guild.", leadsTo: 'ask_lore_guild' },
                            { text: "[Leave] I'll be going.", leadsTo: 'end' }
                        ],
                        reactions: [
                            { condition: { type: 'playerClass', class: 'bounty_hunter' }, npcText: "Another professional. Good. State your business." }
                        ]
                    },
                    'ask_lore_guild': {
                        npcText: 'We uphold the Creed: "No bounty is worth dying for." We provide the contracts, the connections, and the code. You provide the results. It is a dangerous but profitable profession, for those with the skill to survive.',
                        playerChoices: [
                            { text: "I'm ready for work.", leadsTo: 'check_license' },
                            { text: "[Leave] Understood.", leadsTo: 'end' }
                        ]
                    },
                    'check_license': {
                        npcText: "Let's see your license.",
                        playerChoices: [
                            { text: "(Show license)", condition: { type: 'hasItem', itemId: 'bounty_license' }, leadsTo: 'has_license' },
                            { text: "I don't have one.", leadsTo: 'no_license' }
                        ]
                    },
                    'has_license': {
                        npcText: "Verified. The board is open to you. Don't cause trouble in my guild.",
                        playerChoices: [ { text: "[Leave] I won't.", leadsTo: 'end' }]
                    },
                    'no_license': {
                        npcText: "Then you have no business with the board. A license costs 1000 credits. A small price to prove you're serious. Do you want to purchase one?",
                        playerChoices: [
                            { text: "Yes, here are the credits.", condition: { type: 'hasCredits', amount: 1000 }, leadsTo: 'buy_license'},
                            { text: "I can't afford that right now.", leadsTo: 'end'}
                        ]
                    },
                    'buy_license': {
                        npcText: "A wise investment. Your biometric data has been registered. You are now a licensed hunter. The board is available to you. Now, get to work.",
                        playerChoices: [
                            { text: "[Leave] Thank you.", action: { type: 'buyItem', itemId: 'bounty_license', cost: 1000 }, leadsTo: 'end' }
                        ]
                    },
                    'end': null
                }
            },
            'greedo': {
                id: 'greedo',
                name: 'Greedo',
                description: 'A male Rodian with large, black eyes and a green, bumpy snout. He nervously fingers the blaster at his hip, constantly scanning the room.',
                portraitPrompt: "A head and shoulders portrait of Greedo, a male Rodian bounty hunter. He has green, bumpy skin, large, black insect-like eyes, a flexible snout, and short spines on his head. He's wearing a distinctive orange and blue jumpsuit. He looks nervous and shifty. The background is the dim, shadowy interior of the Mos Eisley cantina. Cinematic character concept art.",
                dialogueQuestChecks: [
                    { questId: 'whispers_in_the_wires', activeNode: 'quest_active', completedNode: 'post_quest' }
                ],
                dialogue: {
                    'start': {
                        npcText: 'Wuher said you were coming. I have information, yes, but it is dangerous. And I am in trouble. A rival informant... he thinks I have moved in on his territory. He is causing problems for me, shaking down a client of mine.',
                        playerChoices: [
                            { text: "What do you want me to do?", action: { type: 'startQuest', questId: 'whispers_in_the_wires' }, leadsTo: 'give_quest' },
                            { text: "Not my problem, Rodian.", leadsTo: 'end' }
                        ],
                        reactions: [
                           { condition: { type: 'hasCompanion', companionId: 'kaelen' }, npcText: "You travel with... her? The famous Kaelen Vorr? *Greedo seems even more nervous.* Maybe you can help me after all." }
                        ]
                    },
                    'give_quest': {
                        npcText: "Find this rival, Teemo, at the swoop bike garage. Persuade him to leave my client alone. Do this for me, and I will tell you where to find the slicer you seek. Be careful, he is not the talking type.",
                        playerChoices: [ { text: "[Leave] I'll handle it.", leadsTo: 'end' } ]
                    },
                    'quest_active': {
                        npcText: "Have you dealt with Teemo yet? My client is getting very nervous!",
                        playerChoices: [ { text: "[Leave] I'm on it.", leadsTo: 'end' } ]
                    },
                    'post_quest': {
                        npcText: "You did it! Teemo won't be a problem anymore. As for our deal... a datapad with that kind of Old Republic encryption is beyond any slicer in Mos Eisley. But there are whispers... of an old hermit, a 'wizard' some call him, living out in the Jundland Wastes. They say he knows things from the before times. If anyone can help you, it's him. Look for a destroyed moisture farm. His hut is hidden in the rocks nearby. Go carefully.",
                        playerChoices: [ { text: "[Leave] A garage? Thanks for the info.", action: { type: 'multi', actions: [{type: 'setFlag', flag: 'player_owns_garage', value: true}, {type: 'updateQuestStage', questId: 'the_ghost_in_the_machine', stage: 1}] }, leadsTo: 'disappear' } ]
                    },
                    'disappear': {
                        npcText: "*Greedo quickly slips away into the crowd, disappearing from sight.*",
                        playerChoices: [ { text: "[Continue]", action: { type: 'multi', actions: [{ type: 'removeNpc', npcId: 'greedo' }, { type: 'setFlag', flag: 'greedo_final_convo_done', value: true }] }, leadsTo: 'end' }]
                    },
                    'end': null
                }
            },
            'teemo': {
                id: 'teemo',
                name: 'Teemo',
                description: 'A hulking Weequay pirate, leaning against a half-dismantled swoop bike. He has a cruel sneer on his face and is flanked by a pair of Gamorrean thugs. A sharp-eyed woman in bounty hunter armor watches from the corner.',
                portraitPrompt: "A head and shoulders portrait of Teemo, a tough Weequay pirate. He has coarse, leathery, brown skin and a top-knot of braided hair. He has a cruel sneer on his face. The setting is a greasy, poorly-lit swoop bike garage. Cinematic character concept art.",
                dialogue: {
                    'start': {
                        npcText: "What do you want? This is my garage. Greedo send you? That sniveling little worm is going to get what's coming to him.",
                        playerChoices: [
                            { text: "[Attack] You're done bothering people.", action: { type: 'startCombat', enemyId: 'teemo' } },
                            { text: "[Intimidate/S] Leave Greedo's clients alone, or you'll deal with me.", leadsTo: 'intimidate_check' },
                            { text: "[Persuade/C] There's no profit in this squabble. Let's make a deal.", leadsTo: 'persuade_check' }
                        ]
                    },
                    'intimidate_check': {
                        npcText: "*Teemo spits on the ground.* You think you can scare me? It'll take more than words.",
                        playerChoices: [],
                        action: { type: 'skillCheck', stat: 'S', difficulty: 6, success: 'intimidate_success', failure: 'check_fail' }
                    },
                    'persuade_check': {
                        npcText: "*Teemo narrows his eyes.* A deal? I'm listening. But it better be good.",
                        playerChoices: [],
                        action: { type: 'skillCheck', stat: 'C', difficulty: 7, success: 'persuade_success', failure: 'check_fail' }
                    },
                    'intimidate_success': {
                        npcText: "*He looks you up and down, then at his thugs, and seems to reconsider.* Fine. The client isn't worth this kind of trouble. This town's not worth it either. I'm out of here. The garage is yours, I don't care.",
                        playerChoices: [ { text: "[Leave]", action: { type: 'multi', actions: [{type: 'setFlag', flag: 'teemo_defeated', value: true}, { type: 'completeQuestStage', questId: 'whispers_in_the_wires', stage: 1 }, { type: 'addNews', storyId: 'teemo_defeated_story' }] }, leadsTo: 'end' } ]
                    },
                    'persuade_success': {
                        npcText: "Alright, smooth-talker. Pay me 200 credits for my 'wasted time' and I'll pack up and leave this dustball for good. Deal?",
                        playerChoices: [
                            { text: "Fine, here are the credits.", condition: { type: 'hasCredits', amount: 200 }, action: { type: 'multi', actions: [{type: 'setFlag', flag: 'teemo_defeated', value: true}, { type: 'completeQuestStage', questId: 'whispers_in_the_wires', stage: 1, cost: 200 }, { type: 'addNews', storyId: 'teemo_defeated_story' }] }, leadsTo: 'paid_off' },
                            { text: "[Attack] I'm not paying you a single credit.", action: { type: 'startCombat', enemyId: 'teemo' } }
                        ]
                    },
                    'paid_off': {
                        npcText: "Pleasure doing business with you. Now get out. I'm packing.",
                        playerChoices: [ { text: "[Leave]", leadsTo: 'end' } ]
                    },
                    'check_fail': {
                        npcText: "Nice try. You're not as tough (or smart) as you think you are. Get 'em, boys!",
                        playerChoices: [],
                        action: { type: 'startCombat', enemyId: 'teemo' }
                    },
                    'end': null
                }
            },
            'kaelen_intro': {
                id: 'kaelen_intro',
                name: 'Kaelen Vorr',
                description: 'A sharp-eyed woman with dark hair pulled back into a practical tail. She wears well-maintained bounty hunter armor over a flight suit and her hand never far from the heavy blaster pistol at her hip. She watches you with a mixture of suspicion and grudging respect.',
                portraitPrompt: "A head and shoulders portrait of Kaelen Vorr, a sharp-eyed female human bounty hunter in her late 20s. She has dark hair pulled back into a practical ponytail. She wears well-maintained durasteel bounty hunter armor over a dark flight suit. She has a suspicious and pragmatic expression. The lighting is gritty and realistic. Cinematic character concept art.",
                dialogue: {
                    'start': {
                        npcText: "Took you long enough. I was about to handle that greaseball myself. The name's Kaelen Vorr. Greedo sent you, I presume?",
                        playerChoices: [
                            { text: "He did. Looks like you're safe now.", leadsTo: 'response_humble' },
                            { text: "I had it under control. You're welcome.", leadsTo: 'response_arrogant' },
                            { text: "Who are you? And why was he bothering you?", leadsTo: 'response_curious' }
                        ]
                    },
                    'response_humble': {
                        npcText: "Safe is a strong word on Tatooine. But... you handled that well. Better than Greedo would have. Teemo was trying to muscle in on a bounty I'm tracking. He thought he could scare me off.",
                        playerChoices: [ { text: "What kind of bounty?", leadsTo: 'bounty_info' } ]
                    },
                    'response_arrogant': {
                        npcText: "Is that so? Well, your 'control' looked a lot like 'cornered' from where I was standing. But fine. Thanks for the... noisy distraction. Teemo was trying to muscle in on a bounty I'm tracking.",
                        playerChoices: [ { text: "What kind of bounty?", leadsTo: 'bounty_info' } ]
                    },
                    'response_curious': {
                        npcText: "I already told you my name. As for Teemo, he's a bottom-feeder trying to poach my bounty. He thought a little muscle would scare me off. Bad calculation on his part.",
                        playerChoices: [ { text: "What kind of bounty?", leadsTo: 'bounty_info' } ]
                    },
                    'bounty_info': {
                        npcText: "This bounty... it's connected to a lot of strange whispers. Encrypted comms, Imperial deserters, the works. It all seems to lead back to a single piece of hardware - an old datapad.",
                        playerChoices: [
                            { text: "[Show Datapad] You mean... like this one?", condition: { type: 'hasItem', itemId: 'datapad' }, leadsTo: 'datapad_reveal' },
                            { text: "What does that have to do with me?", leadsTo: 'explain_connection' }
                        ]
                    },
                    'explain_connection': {
                        npcText: "Maybe nothing. But you don't look like a tourist. You look like someone who's either in trouble or looking for it. I'm guessing both. The fact you came here tells me you're tied up in this mess somehow.",
                        playerChoices: [ { text: "You might be right.", leadsTo: 'datapad_reveal' } ]
                    },
                    'datapad_reveal': {
                        npcText: "That's it. So you're the one carrying the ghost. Look, we're both after the same thing, whether you know it or not. The information on that thing is worth more than any bounty, and it's put a target on both our backs. We'd be stronger together.",
                        playerChoices: [
                            { text: "You're right. Let's work together.", action: { type: 'addCompanion', companionId: 'kaelen' }, leadsTo: 'team_up' },
                            { text: "I work alone.", leadsTo: 'decline_offer' }
                        ]
                    },
                    'team_up': {
                        npcText: "Good choice. It'll be more profitable this way. And probably more fun. Now, let's get out of this grease pit and figure out our next move.",
                        playerChoices: [ { text: "[Leave]", action: { type: 'removeNpc', npcId: 'kaelen_intro' }, leadsTo: 'end' } ]
                    },
                    'decline_offer': {
                        npcText: "Suit yourself. But don't come crying to me when you've got a squad of ISB agents on your tail. Good luck, spacer. You're going to need it.",
                        playerChoices: [ { text: "[Leave]", action: { type: 'removeNpc', npcId: 'kaelen_intro' }, leadsTo: 'end' } ]
                    },
                    'end': null
                }
            },
            'vex_maloric': {
                id: 'vex_maloric',
                name: 'Vex Maloric',
                description: "A debonair Devaronian with filed-down horns and an expensive suit. He sips a glowing blue liquid, his sharp eyes missing nothing. He deals in secrets, and his price is always steep.",
                portraitPrompt: "A head and shoulders portrait of Vex Maloric, a debonair male Devaronian information broker. He has reddish skin, pointed ears, and sharp teeth visible in a subtle smile. His two horns have been professionally filed down. He is dressed in an expensive, stylish suit. He looks intelligent and cunning. The setting is a shadowy, exclusive underground casino. Cinematic character concept art.",
                dialogue: {
                    'start': {
                        npcText: "Well, well. A new face in the Shadow Cleft. You're either brave or foolish to wander in here. I'm Vex. I trade in things more valuable than credits... information. What can I do for you?",
                        playerChoices: [
                            { text: "What kind of information do you sell?", leadsTo: 'info_type' },
                            { text: "I'm just looking around.", leadsTo: 'looking_around' },
                            { text: "[Leave] I have no business with you.", leadsTo: 'end' }
                        ]
                    },
                    'looking_around': {
                        npcText: "Of course you are. Everyone is 'just looking' until they need something they can't get elsewhere. When that time comes, you know where to find me.",
                        playerChoices: [ { text: "[Leave] I'll keep that in mind.", leadsTo: 'end' } ]
                    },
                    'info_type': {
                        npcText: "I hear whispers on the hyperlanes... Imperial patrol routes, hidden smuggling caches, the location of a rare weapons schematic... a little bit of everything. For a price, of course.",
                        playerChoices: [
                            { text: "Tell me about the patrol routes.", leadsTo: 'buy_info' },
                            { text: "Let me see that schematic.", leadsTo: 'buy_schematic' },
                            { text: "[Leave] Too rich for my blood.", leadsTo: 'end' }
                        ]
                    },
                    'buy_info': {
                        npcText: "A data shard with the latest Imperial patrol timings around this sector. A ship captain could make a fortune with this. It'll cost you 750 credits.",
                        playerChoices: [
                            { text: "I'll take it. (750 credits)", condition: { type: 'hasCredits', amount: 750 }, action: { type: 'buyItem', itemId: 'vex_intel', cost: 750 }, leadsTo: 'deal_done' },
                            { text: "I can't afford that.", leadsTo: 'too_expensive' }
                        ]
                    },
                    'buy_schematic': {
                        npcText: "Ah, a connoisseur of fine weaponry. I have the schematics for a 'disruptor pistol'. Highly illegal, highly effective. The plans will cost you 1200 credits.",
                        playerChoices: [
                             { text: "I'll take them. (1200 credits)", condition: { type: 'hasCredits', amount: 1200 }, action: { type: 'buyItem', itemId: 'thermal_detonator', cost: 1200 }, leadsTo: 'deal_done' }, // Placeholder item
                             { text: "That's insane.", leadsTo: 'too_expensive' }
                        ]
                    },
                    'deal_done': {
                        npcText: "Pleasure doing business with you. Remember, this conversation never happened.",
                        playerChoices: [ { text: "[Leave]", leadsTo: 'end' } ]
                    },
                    'too_expensive': {
                        npcText: "Quality information demands a quality price. Come back when your pockets are heavier.",
                        playerChoices: [ { text: "[Leave]", leadsTo: 'end' } ]
                    },
                    'end': null
                }
            },
            'sabacc_shark': {
                id: 'sabacc_shark',
                name: 'Sabacc Shark',
                description: 'A grizzled Besalisk with four arms, two of which are always shuffling a deck of Sabacc cards. He has a permanent smirk and a glint in his eye that suggests he\'s never lost a hand he didn\'t mean to.',
                portraitPrompt: "A head and shoulders portrait of a grizzled male Besalisk Sabacc player. He has a bulky, four-armed torso and a finned crest on his head. He has a confident smirk and a cunning glint in his eye. He's wearing a spacer's vest. The background is a smoky, dimly lit cantina. Cinematic character concept art."
            },
            'jawa_vendor': {
                id: 'jawa_vendor',
                name: 'Jik-Jik',
                description: 'A hyperactive Jawa who communicates in excited squeaks and gestures. He proudly points at the bubbling vats and sizzling meats at his food stall.',
                portraitPrompt: "A portrait of Jik-Jik, a Jawa vendor in Mos Eisley. He is a small, humanoid figure completely hidden within a brown, hooded robe. The only visible features are his large, glowing yellow eyes from within the deep shadow of his hood. He is standing in front of his bustling food stall. Cinematic character concept art."
            },
            'roric_fenn': {
                id: 'roric_fenn',
                name: 'Roric Fenn',
                description: 'A human in his late 40s, his face weathered but his eyes sharp. He wears a mix of practical gear and custom Mandalorian-style armor pieces, though he lacks a helmet. He watches you with the patient stillness of a predator.',
                portraitPrompt: "A head and shoulders portrait of Roric Fenn, a veteran male human bounty hunter in his late 40s. He has a weathered face, short-cropped grey hair, and sharp, calculating eyes. He wears a mix of practical gear and custom Mandalorian-style armor pieces (pauldron, chest plate) over a dark flight suit. He does not wear a helmet. He looks patient and dangerous. Cinematic character concept art.",
                dialogueQuestChecks: [
                    { questId: 'echoes_of_the_past', activeNode: 'echoes_active', completedNode: 'echoes_complete' }
                ],
                dialogue: {
                    'start': {
                        npcText: "You handle yourself well. I saw what you did at the garage. That kind of efficiency is rare, but this plaza has too many ears. I represent... a client with deep pockets who needs problems solved. If you're interested in talking business, we can do it somewhere more secure.",
                        playerChoices: [
                            { text: "I'm interested. Lead the way.", action: { type: 'sceneTransition', locationId: 'bounty_hunters_guild_back_room', npcId: 'roric_fenn', nodeId: 'back_room_start', flag: {key: 'roric_met', value: true} } },
                            { text: "I'm busy right now.", leadsTo: 'find_me_later' },
                            { text: "Not interested.", leadsTo: 'not_interested' }
                        ]
                    },
                     'find_me_later': {
                        npcText: "Suit yourself. When you have time for a high-paying contract, find me at the Bounty Hunters' Guild. The offer stands... for now.",
                        playerChoices: [ { text: "[Leave]", action: {type: 'setFlag', flag: 'roric_met', value: true}, leadsTo: 'end' } ]
                    },
                    'not_interested': {
                        npcText: "A pity. Another hunter will get the credits.",
                        playerChoices: [ { text: "[Leave]", action: {type: 'setFlag', flag: 'roric_permanently_declined', value: true}, leadsTo: 'end' } ]
                    },
                    'back_room_start': {
                        npcText: "Good. This is more secure. My client is... influential. They value discretion and results above all else. Before I offer you the real contract, I need to see what you can do. Consider this an audition.",
                        playerChoices: [
                            { text: "What's the job?", leadsTo: 'give_quest_1' }
                        ]
                    },
                    'give_quest_1': {
                        npcText: "A spice runner named Zixx. A small-time player who defaulted on a significant debt to my client. An embarrassment that needs to be erased. He's holed up in an old, abandoned droid shop in the Old Quarter. I don't care how you handle it, but I want it done quietly. No Imperial attention. Bring me proof he's no longer a problem. Do this, and a much more lucrative opportunity awaits.",
                        playerChoices: [ { text: "[Leave] Consider it done.", action: { type: 'startQuest', questId: 'the_hunters_calling' }, leadsTo: 'end' } ]
                    },
                    'hunters_calling_active': {
                        npcText: "What are you waiting for? Zixx isn't going to eliminate himself.",
                        playerChoices: [ { text: "[Leave] I'm on my way.", leadsTo: 'end' } ]
                    },
                    'hunters_calling_complete': {
                        npcText: "So, the spice runner was just bait. I had my suspicions. It seems our target is more cautious than anticipated. This complicates things, but the pay has increased accordingly. Ready for the real hunt?",
                        playerChoices: [
                            { text: "Who's the target?", leadsTo: 'give_quest_2' }
                        ]
                    },
                    'give_quest_2': {
                        npcText: "Commander Valerius. A former Imperial officer from the Intelligence division. He vanished with a head full of secrets my client wants. My sources have tracked him to a hidden comms post. Go there. Neutralize him. Bring me his officer's code cylinder as proof.",
                        playerChoices: [ { text: "[Leave] I'll bring you your proof.", action: { type: 'multi', actions: [{type: 'updateQuestStage', questId: 'echoes_of_the_past', stage: 1}, {type: 'startQuest', questId: 'echoes_of_the_past'}] }, leadsTo: 'end' } ]
                    },
                    'echoes_active': {
                        npcText: "Valerius won't wait around forever. Get to that comms post.",
                        playerChoices: [ { text: "[Leave] I'm going.", leadsTo: 'end' } ]
                    },
                    'echoes_complete': {
                        npcText: "He escaped? And left this behind? *Roric examines the cylinder.* This is... unexpected. Valerius is smarter than I gave him credit for. This isn't over. My client will want him found. I'll be in touch when I have a new lead. Good work, hunter.",
                        playerChoices: [ { text: "[Leave]", action: {type: 'removeNpc', npcId: 'roric_fenn'}, leadsTo: 'end' } ]
                    },
                    'end': null
                }
            },
            'zixx_runner': {
                id: 'zixx_runner',
                name: 'Zixx',
                description: 'A nervous-looking Twi\'lek, surrounded by droid parts. He keeps glancing at the door, his hand trembling near a holdout blaster.',
                portraitPrompt: "A head and shoulders portrait of Zixx, a nervous male Twi'lek spice runner. He has pale blue or grey skin and two head-tails (lekku). He has a frantic, worried expression. He's wearing simple spacer clothes. The background is a cluttered, abandoned droid shop. Cinematic character concept art.",
                dialogue: {
                    'start': {
                        npcText: "Who are you? Did Fenn send you? Look, I'm just the bait! He made me do it, the real target is way above my paygrade! Don't hurt me!",
                        playerChoices: [
                            { text: "Who is the real target?", leadsTo: 'get_info' },
                            { text: "[Intimidate] Talk, or this ends badly for you.", leadsTo: 'get_info' },
                            { text: "[Attack] I don't have time for this.", action: { type: 'startCombat', enemyId: 'zixx_runner' } }
                        ]
                    },
                    'get_info': {
                        npcText: "It's an Imperial! A commander! That's all I know, I swear! Just tell Fenn the job is done, let me go, I'll disappear!",
                        playerChoices: [
                            { text: "Fine. Get out of here.", action: { type: 'updateQuestStage', questId: 'the_hunters_calling', stage: 1 }, leadsTo: 'zixx_flees' }
                        ]
                    },
                    'zixx_flees': {
                        npcText: "Thank you, thank you! You won't see me again!",
                        playerChoices: [ { text: "[Continue]", action: { type: 'removeNpc', npcId: 'zixx_runner' }, leadsTo: 'end' }]
                    },
                    'end': null
                }
            },
            'commander_valerius': {
                id: 'commander_valerius',
                name: 'Commander Valerius',
                description: 'A man in a crisp, black Imperial officer\'s uniform, minus any insignias. He stands calmly before a large comms console, his posture radiating cold, military confidence.',
                portraitPrompt: "A head and shoulders portrait of Commander Valerius, a former Imperial intelligence officer. He is a human male in his 50s with sharp features, short, neat graying hair, and cold, analytical eyes. He wears a crisp, black Imperial officer's uniform without any rank insignias, giving him an air of mystery. His posture is rigid and confident. The background is a high-tech Imperial comms post. Cinematic character concept art.",
                dialogue: {
                    'start': {
                        npcText: "So, the broker finally sent a real professional. I'm impressed. But you're too late. The transaction is complete. You have nothing to gain here but a shallow grave.",
                        playerChoices: [
                            { text: "[Attack] You're not going anywhere.", action: { type: 'startCombat', enemyId: 'commander_valerius' } },
                            { text: "What transaction? Who are you working for?", leadsTo: 'explain' }
                        ]
                    },
                    'explain': {
                        npcText: "Information is power, hunter. And I have just sold a great deal of it to a power far greater than your client. Now, this conversation is over. *He presses a button on the console, and a deafening alarm begins to blare.*",
                        playerChoices: [ { text: "[Attack] You're not getting away!", action: { type: 'startCombat', enemyId: 'commander_valerius' } } ]
                    },
                    'end': null
                }
            },
            'ben_kenobi': {
                id: 'ben_kenobi',
                name: 'Old Ben',
                description: 'An old man in the simple robes of a desert dweller sits at a small table. His eyes, though aged, are sharp and clear, and he watches you with a calm, knowing gaze.',
                portraitPrompt: "A head and shoulders portrait of Old Ben Kenobi on Tatooine. He is an older human male with a grey beard and mustache, kind but wise eyes, and wearing simple, tan hermit robes. The background is the spartan interior of his desert hut. Cinematic character concept art, Star Wars.",
                dialogue: {
                    'start': {
                        npcText: "It has been a long time since I've had a visitor. The Force guided you here, I sense. You carry a heavy burden... and a great secret. Show me the datapad.",
                        playerChoices: [
                            { text: "[Show him the datapad]", leadsTo: 'unlock_datapad' },
                            { text: "Who are you? How do you know about that?", leadsTo: 'who_are_you' }
                        ]
                    },
                    'who_are_you': {
                        npcText: "I am merely a hermit who has seen much of the galaxy. Enough to recognize a soul in turmoil. The datapad... it has a presence about it, an echo of a time long past. Let me see it. I may be able to help.",
                         playerChoices: [
                            { text: "[Show him the datapad]", leadsTo: 'unlock_datapad' },
                            { text: "[Leave] I don't trust you.", leadsTo: 'end' }
                        ]
                    },
                    'unlock_datapad': {
                        npcText: "Ah... Clone Wars encryption. A dark time indeed. This data was not meant for Imperial eyes... or for most, for that matter. *He closes his eyes, placing a hand over the device. The screen flickers, and the encryption melts away, replaced by a single set of coordinates and a message: 'Find the Hope.'*",
                        playerChoices: [
                            { text: "What does it mean? What should I do now?", leadsTo: 'give_advice' }
                        ]
                    },
                    'give_advice': {
                        npcText: "This is your path now. It leads off this rock and into the wider galaxy. It will not be an easy one. You will need this. *He retrieves a cylindrical metal object from a chest.* It was once the weapon of a Jedi Knight. A more elegant weapon, for a more civilized age. Use it well.",
                        playerChoices: [
                            { text: "[Take the lightsaber] Thank you.", action: { type: 'multi', actions: [{ type: 'updateQuestStage', questId: 'the_ghost_in_the_machine', stage: 2 }, { type: 'addItem', itemId: 'training_lightsaber' }] }, leadsTo: 'final_words' }
                        ]
                    },
                     'final_words': {
                        npcText: "The journey begins now. May the Force be with you.",
                         playerChoices: [
                            { text: "[Leave] I won't forget this.", leadsTo: 'end' }
                        ]
                    },
                    'end': null
                }
            },
        };
        const quests = {
            'the_ghost_in_the_machine': {
                id: 'the_ghost_in_the_machine',
                name: 'The Ghost in the Machine',
                isMain: true,
                stages: {
                    0: { description: 'The datapad is locked with old, military-grade encryption. I need to find someone who can help me unlock its secrets.' },
                    1: { description: 'Greedo pointed me towards a mysterious hermit living in the Jundland Wastes. I should look for a destroyed moisture farm out in the wastes to find my way.' },
                    2: { description: "The hermit, Ben, unlocked the datapad. It now displays a set of coordinates and a message: 'Find the Hope.' I need to find a ship to leave Tatooine." }
                }
            },
            'a_foot_in_the_door': {
                id: 'a_foot_in_the_door',
                name: 'A Foot in the Door',
                xpReward: 150,
                stages: {
                    0: { description: 'The bartender, Wuher, wants some Jawa Juice from the Mos Eisley bazaar before he\'ll give me any information.' },
                    1: { description: 'I have given the Jawa Juice to Wuher. He told me to talk to an informant named Greedo.' }
                }
            },
            'whispers_in_the_wires': {
                id: 'whispers_in_the_wires',
                name: 'Whispers in the Wires',
                xpReward: 250,
                stages: {
                    0: { description: 'The informant, Greedo, wants me to deal with a rival named Teemo at the swoop bike garage. Teemo is harassing one of his clients.' },
                    1: { description: 'I dealt with Teemo. I should return to Greedo for my reward.' }
                }
            },
            'the_hunters_calling': {
                id: 'the_hunters_calling',
                name: "The Hunter's Calling",
                isBountyHunterOnly: true,
                xpReward: 300,
                stages: {
                    0: { description: "As a test of my skills, Roric Fenn has hired me to eliminate a spice runner named Zixx, who is hiding out in an abandoned droid shop in the Old Quarter." },
                    1: { description: "I've dealt with Zixx. He was just bait. I should find Roric Fenn at the Bounty Hunter's Guild and report this new development." }
                }
            },
            'echoes_of_the_past': {
                id: 'echoes_of_the_past',
                name: "Echoes of the Past",
                isBountyHunterOnly: true,
                xpReward: 400,
                stages: {
                    0: { description: "Roric Fenn has given me my real target: a rogue Imperial officer named Commander Valerius. I need to learn his location from Roric." },
                    1: { description: "Roric has tracked Valerius to a hidden comms post. I need to travel there and confront him." }
                }
            },
            'shadows_of_the_empire': {
                id: 'shadows_of_the_empire',
                name: "Shadows of the Empire",
                isBountyHunterOnly: true,
                xpReward: 600,
                stages: {
                    0: { description: "I'm on my way to the hidden comms post to confront Commander Valerius." },
                    1: { description: "I confronted Commander Valerius, but he escaped. He left behind a fragmented code cylinder. The hunt continues..." }
                }
            }
        };
        const locations = {
            'mos_eisley_cantina': {
                id: 'mos_eisley_cantina',
                name: 'Mos Eisley Cantina',
                description: 'The infamous Chalmun\'s Cantina. The air is thick with the smell of stale booze, sweat, and exotic spices. A Bith band plays a jaunty tune in the corner, but the low hum of dangerous conversations is the real soundtrack here.',
                description_night: "The cantina is even more crowded at night. The Bith band plays a more somber tune, and the shadows in the booths seem deeper, hiding hushed, urgent conversations. The air is thick with tension and opportunity.",
                npcs: ['wuher'],
                actions: [
                    { name: 'Leave the Cantina', target: 'mos_eisley_spaceport_plaza' },
                    { name: 'Play Sabacc', action: { type: 'sabacc' } }
                ]
            },
            'mos_eisley_spaceport_plaza': {
                id: 'mos_eisley_spaceport_plaza',
                name: 'Mos Eisley Spaceport Plaza',
                description: 'The heart of Mos Eisley\'s public activity. The roar of departing freighters from the nearby docking bays mixes with the chatter of dozens of species. The iconic entrance to Chalmun\'s Cantina stands on one side, while dusty pathways lead to the commercial and older districts of the city.',
                description_night: "Under the light of Tatooine's moons, the plaza transforms. The daytime bustle is replaced by a quieter, more cautious stream of beings. Droids haul cargo under dim floodlights, and cloaked figures finalize illicit deals in the shadows between buildings.",
                npcs: [],
                actions: [
                    { name: 'Enter the Cantina', target: 'mos_eisley_cantina' },
                    { name: 'Head to the Merchant Row', target: 'mos_eisley_merchant_row' },
                    { name: 'Explore the Old Quarter', target: 'mos_eisley_old_quarter' },
                    { name: 'Venture into the Jundland Wastes', target: 'jundland_wastes' }
                ],
                conditionalActions: [
                    {
                        conditions: [
                            { type: 'class', value: 'bounty_hunter' },
                            { type: 'flag_is_true', flag: 'greedo_final_convo_done' },
                            { type: 'flag_is_not_set', flag: 'roric_met' },
                            { type: 'flag_is_not_set', flag: 'roric_permanently_declined' }
                        ],
                        action: { name: "Speak to the figure in Mandalorian-style armor", action: { type: 'talk', npcId: 'roric_fenn' } }
                    }
                ],
                questActions: [
                    { questId: 'echoes_of_the_past', stage: 1, class: 'bounty_hunter', action: { name: 'Travel to the Hidden Comms Post', target: 'imperial_comms_post' } }
                ]
            },
            'mos_eisley_merchant_row': {
                id: 'mos_eisley_merchant_row',
                name: 'Mos Eisley Merchant Row',
                description: 'A narrow, bustling street lined with makeshift stalls and shopfronts carved from sandstone. The air is thick with the smell of sizzling street food and ozone from droid repair shops. Jawas haggle loudly over scavenged parts while merchants call out to passersby.',
                description_night: "Most of the stalls are shuttered for the night, their goods locked away. Only a few food vendors remain open, their sizzling grills casting flickering light onto the empty street. The smell of roasted porg hangs heavy in the cool desert air.",
                npcs: [],
                actions: [
                    { name: 'Go to the Bazaar', target: 'mos_eisley_bazaar' },
                    { name: 'Return to the Spaceport Plaza', target: 'mos_eisley_spaceport_plaza' }
                ]
            },
            'mos_eisley_old_quarter': {
                id: 'mos_eisley_old_quarter',
                name: 'Mos Eisley Old Quarter',
                description: 'The buildings here are older, more weathered. The alleys are tighter and shadows cling to the corners. The sounds of swoop bikes being repaired echo from a dilapidated garage, and the discreet, armored facade of the Bounty Hunters\' Guild suggests that dangerous business is conducted here.',
                description_night: "At night, the Old Quarter feels truly ancient and dangerous. The narrow alleys are cast in deep shadow, broken only by the occasional neon sign from a hidden den. The sounds of distant swoop bikes echo ominously between the weathered sandstone buildings.",
                npcs: [],
                actions: [
                    { name: 'Find the Bounty Hunters\' Guild', target: 'bounty_hunters_guild' },
                    { name: 'Head to the Swoop Garage', target: 'swoop_garage' },
                    { name: 'Return to the Spaceport Plaza', target: 'mos_eisley_spaceport_plaza' }
                ],
                timeSensitiveActions: [
                    { name: 'Slip into a hidden alley casino', target: 'underground_casino', time: 'night' }
                ],
                questActions: [
                    { questId: 'the_hunters_calling', stage: 0, class: 'bounty_hunter', action: { name: 'Investigate the Abandoned Droid Shop', target: 'abandoned_droid_shop' } }
                ]
            },
            'mos_eisley_bazaar': {
                id: 'mos_eisley_bazaar',
                name: 'Mos Eisley Bazaar',
                description: 'A bustling, open-air market filled with Jawas, merchants, and scavengers hawking their wares. The smells of cooked meats and ozone from droid repairs mingle in the air.',
                description_night: "The bazaar is a ghost town at night. Empty stalls and abandoned carts create a maze of shadows under the twin moons. The only sound is the wind whistling through the deserted marketplace.",
                npcs: [],
                actions: [
                    { name: 'Visit the Jawa Food Stall', target: 'jawa_food_stall' },
                    { name: 'Trade with a Junk Dealer', action: { type: 'trade', vendorId: 'junk_dealer' } },
                    { name: 'Return to Merchant Row', target: 'mos_eisley_merchant_row' }
                ]
            },
            'jawa_food_stall': {
                id: 'jawa_food_stall',
                name: 'Jik-Jik\'s Food Stall',
                description: 'A small stall run by a hyperactive Jawa who communicates in excited squeaks and gestures. Various unidentifiable meats sizzle on a grill, and several vats of colorful liquid bubble away.',
                npcs: ['jawa_vendor'],
                actions: [
                    { name: 'Trade with Jik-Jik', action: { type: 'trade', vendorId: 'jawa_vendor' } },
                    { name: 'Return to the Bazaar', target: 'mos_eisley_bazaar' }
                ]
            },
            'bounty_hunters_guild': {
                id: 'bounty_hunters_guild',
                name: 'Bounty Hunters\' Guild',
                description: 'A discreet, armored building tucked away in an alley. Inside, it\'s quiet and professional. A board displays active bounties, and a few grim-faced hunters nurse drinks, cleaning their weapons.',
                npcs: ['guild_admin'],
                actions: [
                    { name: 'Check the Bounty Board', action: { type: 'bounty_board' } },
                    { name: 'Return to the Old Quarter', target: 'mos_eisley_old_quarter' }
                ],
                conditionalActions: [
                     {
                        conditions: [
                            { type: 'flag_is_true', flag: 'roric_met' },
                            { type: 'quest_not_started', questId: 'the_hunters_calling' },
                            { type: 'flag_is_not_set', flag: 'roric_permanently_declined' }
                        ],
                        action: { name: "Talk to Roric Fenn", action: { type: 'sceneTransition', locationId: 'bounty_hunters_guild_back_room', npcId: 'roric_fenn', nodeId: 'back_room_start' } }
                    },
                    {
                        conditions: [
                            { type: 'quest_is_active', questId: 'the_hunters_calling' }
                        ],
                        action: { name: "Report to Roric Fenn", action: { type: 'talk', npcId: 'roric_fenn', nodeId: 'hunters_calling_complete' } }
                    }
                ]
            },
            'bounty_hunters_guild_back_room': {
                id: 'bounty_hunters_guild_back_room',
                name: 'Guild Back Room',
                description: 'A private office, spartan but secure. A large holotable dominates the center of the room, currently inactive. The walls are lined with weapon lockers and surveillance monitors.',
                npcs: ['roric_fenn'],
                actions: [
                    { name: 'Leave the Back Room', target: 'bounty_hunters_guild' }
                ]
            },
             'swoop_garage': {
                id: 'swoop_garage',
                name: 'Swoop Bike Garage',
                description: 'A greasy, dilapidated garage smelling of fuel and ozone. Repulsorlift parts are scattered everywhere. A few rough-looking individuals eye you with suspicion.',
                npcs: ['teemo'],
                actions: [
                    { name: 'Return to the Old Quarter', target: 'mos_eisley_old_quarter' }
                ]
            },
            'player_safehouse_garage': {
                id: 'player_safehouse_garage',
                name: 'Your Hideout',
                description: 'The garage is your private workshop, a quiet space away from the desert\'s glare. The faint, clean smell of machine oil and ozone has replaced the grime of its previous owner. Your swoop bike rests in the corner, a promise of swift travel, while a heavy workbench against the back wall waits for your next project. A discreet maintenance panel hints at more than meets the eye.',
                description_night: "Under the cool light of Tatooine's moons filtering through the grimy windows, the garage becomes a silent sanctuary. The polished chrome of your swoop bike glints in the darkness, and the tools on your workbench cast long, peaceful shadows. It's a secure haven, the thick walls muffling the distant cries of the desert night.",
                npcs: [],
                actions: [
                    { name: 'Access hidden panel', target: 'player_safehouse_interior' },
                    { name: 'Return to the Old Quarter', target: 'mos_eisley_old_quarter' }
                ]
            },
            'player_safehouse_interior': {
                id: 'player_safehouse_interior',
                name: 'Safehouse Living Quarters',
                description: 'The hidden door slides open to reveal a surprisingly comfortable living space. The air is cool and still, a welcome escape from the blistering heat outside. A simple but clean cot is tucked into one corner, and a personal storage locker stands ready for your gear. The low, comforting hum of a HoloNet terminal provides a steady connection to the wider galaxy. It\'s a small, secret refuge that feels entirely your own.',
                description_night: "The living quarters are a pool of soft, low light, a cozy retreat from the desert's chill. The cot looks inviting, promising a safe and restful sleep. The quiet hum of the HoloNet terminal is a reassuring presence in the silence, a reminder that even on this remote world, you are connected. This is your sanctuary, a place where the dangers of the Outer Rim feel a million parsecs away.",
                npcs: [],
                actions: [
                    { name: 'Access HoloNet Terminal', action: { type: 'holonet' } },
                    { name: 'Return to the Garage', target: 'player_safehouse_garage' },
                    { name: 'Rest', action: { type: 'rest' } }
                ]
            },
            'underground_casino': {
                id: 'underground_casino',
                name: 'The Shadow Cleft',
                description: "Hidden behind a grimy alley door is a surprisingly opulent, yet smoky, casino. The air hums with the low murmur of high-stakes deals and the electric snap of Sabacc cards. Beings from across the criminal underworld watch each other with greedy eyes, their faces illuminated by the holographic glow of the gaming tables.",
                description_night: "At night, the Shadow Cleft is in its element. The casino floor is packed, the air thick with smoke and the electric thrill of high-stakes gambling. Credits and secrets are being won and lost with every passing moment.",
                npcs: ['vex_maloric', 'sabacc_shark'],
                actions: [
                    { name: 'Play High-Stakes Sabacc', action: { type: 'sabacc', ante: 50 } },
                    { name: 'Return to the Old Quarter', target: 'mos_eisley_old_quarter' }
                ]
            },
            'abandoned_droid_shop': {
                id: 'abandoned_ droid_shop',
                name: 'Abandoned Droid Shop',
                description: 'The air is thick with the smell of rust and ozone. Deactivated droid chassis in various states of disrepair are piled in the corners. It is eerily quiet.',
                npcs: ['zixx_runner'],
                actions: [
                    { name: 'Return to the Old Quarter', target: 'mos_eisley_old_quarter' }
                ]
            },
            'imperial_comms_post': {
                id: 'imperial_comms_post',
                name: 'Hidden Imperial Comms Post',
                description: 'A prefabricated Imperial structure, cleverly hidden inside a hollowed-out rock formation. Inside, the sterile black and grey consoles of a high-tech listening post hum with power. It is clearly still active.',
                npcs: ['commander_valerius'],
                actions: [
                    { name: 'Return to the Spaceport Plaza', target: 'mos_eisley_spaceport_plaza' }
                ]
            },
            'jundland_wastes': {
                id: 'jundland_wastes',
                name: 'Jundland Wastes',
                description: 'The scorching twin suns beat down on an endless expanse of sand and rock. The wind howls, carrying the distant, eerie cry of a krayt dragon. This is a dangerous, lawless place.',
                description_night: 'Under the three moons of Tatooine, the desert is deceptively beautiful and cold. The shadows between the rock formations are deep and could hide anything from a Jawa sandcrawler to a hungry predator.',
                npcs: [],
                actions: [
                    { name: 'Return to Mos Eisley', target: 'mos_eisley_spaceport_plaza' }
                ],
                questActions: [
                    { questId: 'the_ghost_in_the_machine', stage: 1, action: { name: 'Search for the destroyed moisture farm', target: 'destroyed_homestead_site' } }
                ]
            },
            'destroyed_homestead_site': {
                id: 'destroyed_homestead_site',
                name: 'Destroyed Homestead',
                description: 'You stand before the smoking ruins of a moisture farm, a tragic monument to the harshness of the desert. It looks like it was recently attacked by Tusken Raiders. Following Greedo\'s directions, you scan the nearby rock formations for any sign of a hidden dwelling.',
                npcs: [],
                actions: [
                    { name: 'Follow a faint path into the rocks', target: 'ben_kenobis_hut' },
                    { name: 'Return to the Jundland Wastes', target: 'jundland_wastes' }
                ]
            },
            'ben_kenobis_hut': {
                id: 'ben_kenobis_hut',
                name: 'Hermit\'s Hut',
                description: 'Tucked away in a small canyon is a simple hut made of rock and sand-blasted metal. A strange sense of peace hangs in the air here, a stark contrast to the dangers of the wastes outside. A mysterious old man in simple robes looks up as you enter.',
                npcs: ['ben_kenobi'],
                actions: [
                    { name: 'Leave the hut', target: 'jundland_wastes' }
                ]
            },
        };
        const vendors = {
            'junk_dealer': {
                name: 'Watto\'s Cousins\' Junk Shop',
                inventory: [ 'scavenged_armor_jacket', 'vibroknife', 'medpac', 'repair_kit', 'ration_pack', 'macrobinoculars' ]
            },
            'jawa_vendor': {
                name: "Jik-Jik's Food Stall",
                inventory: [ 'jawa_juice', 'roasted_porg_leg', 'blue_milk_canteen' ]
            }
        };
        const companions = {
            'kaelen': {
                id: 'kaelen',
                name: 'Kaelen Vorr',
                description: 'A former Imperial sharpshooter who defected after a crisis of conscience during a brutal crackdown on a civilian uprising. Her cynicism is a shield for a deeply ingrained sense of justice. She\'s pragmatic, deadly with a rifle, and fiercely loyal to the few she trusts.',
                stats: { S: 4, P: 8, E: 5, C: 4, I: 6, A: 7, L: 5, HP: 55, MaxHP: 55 },
                equipped: { weapon: 'heavy_blaster_pistol', armor: 'bounty_hunter_armor' }
            }
        };
        const enemies = {
            'teemo': {
                id: 'teemo',
                name: 'Teemo the Weequay',
                stats: { S: 7, P: 5, E: 6, C: 3, I: 4, A: 5, L: 4, HP: 70, MaxHP: 70 },
                equipped: { weapon: 'heavy_blaster_pistol' },
                loot: ['credits_pouch', 'spice_vial'],
                allies: [ 'gamorrean_thug', 'gamorrean_thug' ],
                xpValue: 100,
                victoryAction: { type: 'multi', actions: [{ type: 'completeQuestStage', questId: 'whispers_in_the_wires', stage: 1 }, { type: 'addNews', storyId: 'teemo_defeated_story' }] }
            },
            'gamorrean_thug': {
                id: 'gamorrean_thug',
                name: 'Gamorrean Thug',
                stats: { S: 8, P: 3, E: 7, C: 2, I: 2, A: 4, L: 3, HP: 40, MaxHP: 40 },
                equipped: { weapon: 'vibroknife' },
                loot: ['ration_pack'],
                xpValue: 40
            },
            'zixx_runner': {
                id: 'zixx_runner',
                name: 'Zixx',
                stats: { S: 3, P: 6, E: 4, C: 5, I: 5, A: 7, L: 6, HP: 45, MaxHP: 45 },
                equipped: { weapon: 'blaster_pistol' },
                loot: ['spice_vial'],
                xpValue: 75,
                victoryAction: { type: 'updateQuestStage', questId: 'the_hunters_calling', stage: 1 }
            },
            'commander_valerius': {
                id: 'commander_valerius',
                name: 'Commander Valerius',
                stats: { S: 6, P: 8, E: 7, C: 7, I: 9, A: 8, L: 6, HP: 120, MaxHP: 120 },
                equipped: { weapon: 'heavy_blaster_pistol' },
                loot: ['imperial_code_cylinder'],
                xpValue: 350,
                victoryAction: { type: 'multi', actions: [
                    { type: 'updateQuestStage', questId: 'echoes_of_the_past', stage: 1 },
                    { type: 'updateQuestStage', questId: 'shadows_of_the_empire', stage: 1 },
                    { type: 'addNews', storyId: 'valerius_escaped_story' }
                ]}
            },
            'imperial_stormtrooper_leader': {
                id: 'imperial_stormtrooper_leader',
                name: 'Stormtrooper Sergeant',
                stats: { S: 6, P: 6, E: 6, C: 4, I: 5, A: 6, L: 4, HP: 60, MaxHP: 60 },
                equipped: { weapon: 'heavy_blaster_pistol' },
                loot: ['medpac'],
                allies: ['imperial_stormtrooper', 'imperial_stormtrooper'],
                xpValue: 80
            },
            'imperial_stormtrooper': {
                id: 'imperial_stormtrooper',
                name: 'Stormtrooper',
                stats: { S: 5, P: 5, E: 5, C: 3, I: 4, A: 5, L: 3, HP: 35, MaxHP: 35 },
                equipped: { weapon: 'blaster_pistol' },
                loot: ['ration_pack'],
                xpValue: 30
            },
            'tusken_raider': {
                id: 'tusken_raider',
                name: 'Tusken Raider',
                stats: { S: 7, P: 6, E: 7, C: 2, I: 3, A: 6, L: 5, HP: 50, MaxHP: 50 },
                equipped: { weapon: 'vibroknife' }, // Gaderffii stick equivalent
                loot: ['ration_pack'],
                allies: ['tusken_raider'],
                xpValue: 60
            }
        };
        const encounters = {
            'imperial_patrol': {
                id: 'imperial_patrol',
                name: 'Random Encounter',
                dialogue: {
                    'start': {
                        npcText: "Rounding a corner, you nearly run into a patrol of Imperial Stormtroopers locking down the street. They haven't seen you yet. What do you do?",
                        playerChoices: [
                            { text: "[Hide] Duck into a nearby alleyway.", leadsTo: 'hide_check' },
                            { text: "[Sneak/A] Try to slip past them unnoticed.", leadsTo: 'sneak_check' },
                            { text: "[Attack] Ambush them before they know what's happening.", action: { type: 'startCombat', enemyId: 'imperial_stormtrooper_leader' } }
                        ]
                    },
                    'hide_check': {
                        npcText: "*You press yourself into the shadows of a grimy alley, holding your breath as the clanking of their armor grows louder...*",
                        playerChoices: [],
                        action: { type: 'chanceCheck', chance: 0.8, success: 'avoid_success', failure: 'spotted' }
                    },
                    'sneak_check': {
                        npcText: "*You try to use the sparse crowd and market stalls as cover, moving carefully from shadow to shadow...*",
                        playerChoices: [],
                        action: { type: 'skillCheck', stat: 'A', difficulty: 7, success: 'avoid_success', failure: 'spotted' }
                    },
                    'avoid_success': {
                        npcText: "The patrol marches past, oblivious to your presence. You wait for their footsteps to fade before continuing on your way. You avoided the encounter.",
                        playerChoices: [ { text: "[Continue]", leadsTo: 'end' } ]
                    },
                    'spotted': {
                        npcText: "A trooper's helmet snaps in your direction. 'Hey! You! Stop right there!' The patrol raises their blasters. There's no escaping a fight now.",
                        playerChoices: [ { text: "[Fight!]", action: { type: 'startCombat', enemyId: 'imperial_stormtrooper_leader' }, leadsTo: 'end' } ]
                    },
                    'end': null
                }
            },
            'tusken_raider_ambush': {
                id: 'tusken_raider_ambush',
                name: 'Random Encounter',
                dialogue: {
                    'start': {
                        npcText: "A blood-curdling cry echoes from the rocks above! You're ambushed by a pair of Tusken Raiders, their cycler rifles aimed at you. They gesture aggressively with their gaderffii sticks.",
                        playerChoices: [
                            { text: "[Intimidate/S] You roar back, brandishing your weapon.", leadsTo: 'intimidate_check' },
                            { text: "[Tribute] Offer them some credits to leave you alone.", leadsTo: 'tribute' },
                            { text: "[Attack] Open fire!", action: { type: 'startCombat', enemyId: 'tusken_raider' } }
                        ]
                    },
                    'intimidate_check': {
                        npcText: "*You stand your ground, making yourself look as threatening as possible. The Tuskens pause, considering you...*",
                        playerChoices: [],
                        action: { type: 'skillCheck', stat: 'S', difficulty: 8, success: 'intimidate_success', failure: 'intimidate_fail' }
                    },
                    'intimidate_success': {
                        npcText: "Your aggressive display gives them pause. After a tense moment, they let out a final guttural cry and melt back into the rocks. You've avoided a fight... this time.",
                        playerChoices: [ { text: "[Continue]", leadsTo: 'end' } ]
                    },
                    'intimidate_fail': {
                        npcText: "They are not impressed. They see your display as a challenge, and they charge forward with a savage howl!",
                        playerChoices: [ { text: "[Fight!]", action: { type: 'startCombat', enemyId: 'tusken_raider' }, leadsTo: 'end' } ]
                    },
                    'tribute': {
                        npcText: "You hold out a handful of credits. One of the raiders approaches cautiously, snatches the money, then lets out a sharp cry. The two of them lower their weapons and retreat into the canyons.",
                        playerChoices: [ { text: "[Continue]", action: { type: 'buyItem', cost: 50 }, leadsTo: 'end' } ] // using buyItem to remove credits
                    },
                    'end': null
                }
            }
        };
        const holonetStories = {
            'market_report': {
                id: 'market_report',
                headline: 'Anchorhead Market Report: Bantha Fodder Prices Soar',
                content: "Traders at the Anchorhead market are reporting a sharp increase in the price of bantha fodder, citing recent Tusken Raider activity along the main trade routes. 'It's getting harder and harder to get a convoy through from the Dune Sea,' said one moisture farmer. 'If this keeps up, we'll all be drinking recycled water for a month.' Local officials have yet to comment."
            },
            'teemo_defeated_story': {
                id: 'teemo_defeated_story',
                headline: 'Gangland Scuffle Shakes Old Quarter',
                content: "A violent confrontation erupted at a swoop bike garage in Mos Eisley's Old Quarter, leading to the hasty departure of local tough, Teemo. Eyewitnesses report a newcomer to the city was involved in the altercation, which saw Teemo and his associates either driven off or... permanently retired. The garage has since fallen under new management. Local authorities have not opened an investigation, citing 'a lack of credible witnesses.'"
            },
            'valerius_escaped_story': {
                id: 'valerius_escaped_story',
                headline: 'Imperial Checkpoints Increase Following "Training Exercise"',
                content: "Travelers in the Mos Eisley sector are reporting a significant increase in Imperial checkpoints and patrols. An Imperial spokesman attributed the heightened security to a 'routine training exercise' near the Jundland Wastes. However, rumors persist of a firefight at a hidden communications post, possibly involving a high-ranking Imperial defector. The Empire has denied these rumors, warning citizens against spreading seditious gossip."
            }
        };

        // --- GAME STATE ---
        function initializeGameState() {
            return {};
        }
        let gameState = initializeGameState();
        let ai = null;
        let typewriterTimeout;
        let tipInterval = null;

        // --- UTILITY FUNCTIONS ---
        const getRandomElement = (arr) => arr[Math.floor(Math.random() * arr.length)];
        const rollCheck = (statValue) => Math.floor(Math.random() * 10) + 1 + statValue;

        function typeText(element, htmlString, onComplete) {
            if (!element) return;
            clearTimeout(typewriterTimeout);

            const indicatorId = 'skip-indicator';
            const removeIndicator = () => {
                const existingIndicator = document.getElementById(indicatorId);
                if (existingIndicator) existingIndicator.remove();
            };
            
            removeIndicator(); // Clean up previous ones

            let indicatorParent = element.closest('.dialogue-main') || element.closest('#log-box');
            if (indicatorParent) {
                let indicator = document.createElement('div');
                indicator.id = indicatorId;
                indicator.className = 'skip-indicator';
                indicator.textContent = '[Click to skip]';
                indicatorParent.appendChild(indicator);
            }

            const completionCallback = { run: onComplete };

            const skipTyping = () => {
                clearTimeout(typewriterTimeout);
                removeIndicator();
                element.innerHTML = htmlString;
                const logHistory = document.getElementById('log-history');
                if (logHistory) {
                    logHistory.scrollTop = logHistory.scrollHeight;
                }
                gameState.ui.isTyping = false;
                document.body.removeEventListener('click', skipTyping, true);
                
                if (completionCallback.run) {
                    completionCallback.run();
                    completionCallback.run = null;
                }
            };

            document.body.addEventListener('click', skipTyping, true);

            gameState.ui.isTyping = true;
            element.innerHTML = '';
            let i = 0;
            const logHistoryEl = document.getElementById('log-history');

            function type() {
                if (i < htmlString.length) {
                    if (htmlString.substring(i, i + 1) === '<') {
                        const tagEndIndex = htmlString.indexOf('>', i);
                        if (tagEndIndex !== -1) {
                            element.innerHTML += htmlString.substring(i, tagEndIndex + 1);
                            i = tagEndIndex;
                        }
                    } else {
                        element.innerHTML += htmlString.substring(i, i + 1);
                    }
                    i++;

                    if (logHistoryEl) {
                        logHistoryEl.scrollTop = logHistoryEl.scrollHeight;
                    }
                    typewriterTimeout = setTimeout(type, 5); // Faster typing speed
                } else {
                    removeIndicator();
                    gameState.ui.isTyping = false;
                    document.body.removeEventListener('click', skipTyping, true);
                    if (completionCallback.run) {
                        completionCallback.run();
                        completionCallback.run = null;
                    }
                }
            }
            type();
        }

        // --- SAVE/LOAD FUNCTIONS ---
        function saveGame() {
            localStorage.setItem('outerRimSaveData', JSON.stringify(gameState));
            console.log('Game Saved!');
            addToLog('<p class="text-green-400">Game Saved!</p>');
        }

        async function loadGame() {
            const savedData = localStorage.getItem('outerRimSaveData');
            if (savedData) {
                gameState = JSON.parse(savedData);
                if (!gameState.time) {
                    gameState.time = 'day';
                }
                console.log('Game Loaded!');
                await reinitializeAiFromState();
                render();
                addToLog('<p class="text-green-400">Game Loaded from Browser Storage.</p>');
            } else {
                console.log('No save data found.');
                alert('No save data found in browser storage.');
            }
        }
        
        function saveGameAsHtml() {
            const stateString = JSON.stringify(gameState);
            const originalHtml = document.documentElement.outerHTML;

            // Find the embedded script tag and replace its content
            const parser = new DOMParser();
            const doc = parser.parseFromString(originalHtml, 'text/html');
            const scriptTag = doc.getElementById('embedded-save-data');
            if(scriptTag) {
                scriptTag.textContent = stateString;
            }

            const newHtml = doc.documentElement.outerHTML;
            
            const blob = new Blob([newHtml], { type: 'text/html' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'The_Outer_Rim_Save.html';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        // --- CORE LOGIC ---
        function getPlayerStat(stat) {
            let value = gameState.character.stats[stat] || 0;
            // Add bonuses from equipment
            for (const slot in gameState.character.equipped) {
                const itemId = gameState.character.equipped[slot];
                if (itemId) {
                    const item = items[itemId];
                    if (item.bonus && item.bonus[stat]) {
                        value += item.bonus[stat];
                    }
                }
            }
            return value;
        }

        function calculateMaxHP(endurance) {
            return 50 + (endurance * 5);
        }

        function addItemToInventory(itemId) {
            const item = items[itemId];
            if (!item) return;

            if (item.type === 'currency') {
                 gameState.credits += item.value;
                 return;
            }

            const existingItem = gameState.inventory.find(i => i.id === itemId);
            if (existingItem && ['consumable', 'quest'].includes(item.type)) { // Allow stacking for consumables and certain quest items
                existingItem.quantity = (existingItem.quantity || 1) + 1;
            } else {
                gameState.inventory.push({ id: itemId, quantity: 1 });
            }
        }
        
        function removeItemFromInventory(itemId, quantity = 1) {
            const itemIndex = gameState.inventory.findIndex(i => i.id === itemId);
            if (itemIndex > -1) {
                const item = gameState.inventory[itemIndex];
                if (item.quantity > quantity) {
                    item.quantity -= quantity;
                } else {
                    gameState.inventory.splice(itemIndex, 1);
                }
            }
        }
        
        function gainXP(amount) {
            if (!amount || amount <= 0) return;
            const char = gameState.character;
            addToLog(`<p class="text-blue-300 font-bold">+${amount} XP</p>`);
            char.xp += amount;
            while (char.xp >= char.xpToNextLevel) {
                levelUp();
            }
            // Manually re-render just the character sheet to update the XP bar immediately
            const charSheet = document.getElementById('character-sheet-box');
            if (charSheet) renderCharacterSheet(charSheet);
        }

        function levelUp() {
            const char = gameState.character;
            char.xp -= char.xpToNextLevel;
            char.level++;
            char.xpToNextLevel = char.level * 1000;
            char.attributePoints = (char.attributePoints || 0) + 1;
            
            const hpGain = Math.floor(getPlayerStat('E') / 2) + 5;
            char.maxHp += hpGain;
            char.hp = char.maxHp; // Full heal

            addToLog('<p class="text-yellow-300 font-bold text-lg animate-pulse">** LEVEL UP! **</p>');
            addToLog(`<p class="text-yellow-400">You are now Level ${char.level}! You have a point to spend.</p>`);
        }

        function handleSceneTransition(action) {
            const root = document.getElementById('root');
            const overlay = document.createElement('div');
            overlay.style.position = 'fixed';
            overlay.style.inset = '0';
            overlay.style.backgroundColor = 'black';
            overlay.style.zIndex = '100';
            overlay.style.opacity = '0';
            overlay.style.transition = 'opacity 0.5s ease-in-out';
            root.appendChild(overlay);

            // Force reflow to apply initial opacity
            void overlay.offsetWidth;

            overlay.style.opacity = '1';

            setTimeout(() => {
                if (action.flag) {
                    gameState.flags[action.flag.key] = action.flag.value;
                }
                gameState.locationId = action.locationId;
                // startDialogue will call render, which removes the overlay, but the dialogue modal will be on top.
                startDialogue(action.npcId, action.nodeId);
            }, 600); // Wait for fade out
        }


        function processAction(action) {
            if (!action) return;

            if (action.type === 'multi') {
                action.actions.forEach(subAction => processAction(subAction));
                return;
            }

            switch (action.type) {
                case 'sceneTransition':
                    handleSceneTransition(action);
                    break;
                case 'startQuest':
                    if (!gameState.quests[action.questId]) {
                        gameState.quests[action.questId] = { id: action.questId, stage: 0, completed: false };
                         addToLog(`<p class="text-yellow-400">Quest Started: ${quests[action.questId].name}</p>`);
                    }
                    break;
                case 'updateQuestStage':
                    if (gameState.quests[action.questId]) {
                        const questData = quests[action.questId];
                        const questState = gameState.quests[action.questId];
                        
                        questState.stage = action.stage;
                        addToLog(`<p class="text-yellow-400">Quest Updated: ${quests[action.questId].name}</p>`);
                        
                        const lastStage = Object.keys(questData.stages).length - 1;
                        if (action.stage >= lastStage) {
                            if(questData.xpReward && !questState.completed) {
                                gainXP(questData.xpReward);
                            }
                            questState.completed = true;
                        }
                    }
                    break;
                case 'completeQuestStage':
                     if (gameState.quests[action.questId] && !gameState.quests[action.questId].completed) {
                        const questData = quests[action.questId];
                        const lastStage = Object.keys(questData.stages).length - 1;
                        
                        gameState.quests[action.questId].stage = lastStage;
                        gameState.quests[action.questId].completed = true;

                        if(action.cost) {
                            gameState.credits -= action.cost;
                        }
                        addToLog(`<p class="text-yellow-400">Quest Completed: ${questData.name}</p>`);
                        
                        if (questData.xpReward) {
                            gainXP(questData.xpReward);
                        }
                        
                        // Custom logic for Kaelen's introduction
                        if (action.questId === 'whispers_in_the_wires') {
                            const teemoLocation = locations['swoop_garage'];
                            if (teemoLocation && teemoLocation.npcs && teemoLocation.npcs.includes('teemo')) {
                                teemoLocation.npcs = teemoLocation.npcs.filter(id => id !== 'teemo');
                            }
                            if(teemoLocation && teemoLocation.npcs && !teemoLocation.npcs.includes('kaelen_intro')) {
                                teemoLocation.npcs.push('kaelen_intro');
                            }

                            // Use a timeout to let the current modal (combat/dialogue) close gracefully
                            setTimeout(() => startDialogue('kaelen_intro'), 500);
                        }
                    }
                    break;
                case 'addNpc':
                    const loc = locations[action.locationId];
                    if (loc && loc.npcs && !loc.npcs.includes(action.npcId)) {
                        loc.npcs.push(action.npcId);
                        if(action.locationId === gameState.locationId){
                            gameState.ui.justMoved = true; // Force action refresh
                        }
                    }
                    break;
                case 'addCompanion':
                    if (!gameState.companions.some(c => c.id === action.companionId)) {
                        gameState.companions.push({ id: action.companionId });
                        const companionData = companions[action.companionId];
                        addToLog(`<p class="text-green-400 font-bold">${companionData.name} has joined your crew!</p>`);
                    }
                    break;
                case 'addItem':
                    addItemToInventory(action.itemId);
                    addToLog(`<p class="text-green-400">You received: ${items[action.itemId].name}.</p>`);
                    break;
                case 'removeItem':
                    removeItemFromInventory(action.itemId);
                    break;
                case 'buyItem':
                    if (gameState.credits >= action.cost) {
                        gameState.credits -= action.cost;
                        if (action.itemId) { // some actions might just be payments
                            addItemToInventory(action.itemId);
                            addToLog(`<p class="text-gray-400">You bought ${items[action.itemId].name}.</p>`);
                        }
                    } else {
                         addToLog(`<p class="text-red-400">You don't have enough credits.</p>`);
                    }
                    break;
                case 'removeNpc':
                    const allLocations = Object.values(locations);
                    for(const location of allLocations) {
                         if (location && location.npcs && location.npcs.includes(action.npcId)) {
                            location.npcs = location.npcs.filter(id => id !== action.npcId);
                         }
                    }
                     // Also check for the special intro case
                    if (action.npcId === 'kaelen_intro') {
                         const swoopGarage = locations['swoop_garage'];
                         if (swoopGarage && swoopGarage.npcs && swoopGarage.npcs.includes('kaelen_intro')) {
                            swoopGarage.npcs = swoopGarage.npcs.filter(id => id !== 'kaelen_intro');
                         }
                    }
                    if (gameState.locationId) {
                        gameState.ui.justMoved = true; // Force action refresh
                    }
                    break;
                case 'startCombat':
                    startCombat(action.enemyId);
                    break;
                case 'skillCheck':
                    const result = rollCheck(getPlayerStat(action.stat));
                    const nextNode = result >= action.difficulty ? action.success : action.failure;
                    if (result >= action.difficulty) {
                        gainXP(25); // Award XP for successful skill check
                    }
                    const modalType = gameState.modal.type;
                    if (modalType === 'encounter') {
                         startEncounter(gameState.modal.context.npcId, nextNode);
                    } else {
                        startDialogue(gameState.modal.context.npcId, nextNode);
                    }
                    break;
                case 'chanceCheck':
                    const success = Math.random() < action.chance;
                    const nextNodeChance = success ? action.success : action.failure;
                    const modalTypeChance = gameState.modal.type;
                    if (modalTypeChance === 'encounter') {
                         startEncounter(gameState.modal.context.npcId, nextNodeChance);
                    } else {
                        startDialogue(gameState.modal.context.npcId, nextNodeChance);
                    }
                    break;
                case 'setFlag':
                    gameState.flags[action.flag] = action.value;
                    break;
                case 'rest':
                    const wasDay = gameState.time === 'day';
                    gameState.time = wasDay ? 'night' : 'day';
                    gameState.character.hp = gameState.character.maxHp;
                    const timeTerm = wasDay ? 'night' : 'morning';
                    addToLog(`<p class="text-cyan-300">You rest on the cot, feeling your wounds mend. You wake fully recovered. It is now ${timeTerm}.</p>`);
                    break;
                case 'holonet':
                    startHoloNet();
                    break;
                case 'addNews':
                    if (!gameState.holonetNews.includes(action.storyId)) {
                        gameState.holonetNews.unshift(action.storyId); // unshift to put new news at the top
                        const storyData = holonetStories[action.storyId];
                        addToLog(`<p class="text-cyan-300">[HoloNet Update: ${storyData.headline}]</p>`);
                    }
                    break;
            }
        }

        // --- RENDER FUNCTIONS ---
        function render() {
            const root = document.getElementById('root');
            const screen = gameState.screen;

            if (screen === 'menu') {
                renderMainMenu(root);
                return;
            }
            if (screen === 'welcome') {
                renderWelcomeScreen(root);
                return;
            }
            if (screen === 'api_key') {
                renderApiKeyScreen(root);
                return;
            }
            if (screen === 'creator') {
                renderCreator(root);
                return;
            }
             if (screen === 'cutscene') {
                renderCutscene(root);
                return;
            }
            if (screen === 'preloading') {
                renderPreloadingScreen(root);
                return;
            }
            if (screen === 'levelUp') {
                renderLevelUpScreen(root);
                return;
            }


            document.body.classList.add('game-active');
            
            // Main game UI
            root.innerHTML = `
                <div class="game-grid p-4 gap-4">
                    <div id="image-box" class="grid-quadrant bg-gray-800 rounded-lg overflow-hidden relative flex items-center justify-center"></div>
                    <div id="character-sheet-box" class="grid-quadrant bg-gray-800 rounded-lg p-4 overflow-y-auto custom-scrollbar"></div>
                    <div id="log-box" class="grid-quadrant bg-gray-800 rounded-lg p-4 flex flex-col overflow-hidden"></div>
                    <div id="interactive-box" class="grid-quadrant bg-gray-800 rounded-lg flex flex-col p-4 overflow-hidden"></div>
                </div>
                 <div id="modal-container"></div>
            `;

            renderImageBox();
            renderCharacterSheet(document.getElementById('character-sheet-box'));
            renderInteractiveBox();
            renderLogAndInput();
            
            if (gameState.modal) {
                switch(gameState.modal.type) {
                    case 'dialogue':
                    case 'encounter':
                        renderDialogueModal(); 
                        break;
                    case 'combat': renderCombatModal(); break;
                    case 'vendor': renderVendorModal(); break;
                    case 'sabacc': renderSabaccModal(); break;
                    case 'holonet': renderHoloNetModal(); break;
                }
            }
            
            if (gameState.ui.justMoved) {
                gameState.ui.justMoved = false;
                displayCurrentLocation();
            }

            attachUIEventListeners();
        }
        
        function renderImageBox() {
            const container = document.getElementById('image-box');
            if (!container) return;
            const imageKey = `${gameState.locationId}_${gameState.time}`;
            const imageUrl = gameState.ui.locationImages[imageKey];
            const useAi = gameState.settings?.useAiImages ?? true;

            if (imageUrl) {
                 container.innerHTML = `<img src="${imageUrl}" class="w-full h-full object-cover animate-fade-in" />`;
            } else if (useAi) {
                 container.innerHTML = `
                    <div class="text-center text-gray-400">
                        <div class="spinner mx-auto mb-2"></div>
                        <p>Generating Scene...</p>
                    </div>
                 `;
                 generateLocationImage(gameState.locationId);
            } else {
                // Offline mode placeholder
                container.innerHTML = `
                    <div class="w-full h-full flex items-center justify-center bg-black">
                        <p class="text-gray-500 font-mono">[ Visuals Disabled ]</p>
                    </div>
                `;
            }
        }

        function renderCharacterSheet(container) {
            if (!container) return;
            const { name, level, race, characterClass, stats, hp, maxHp, xp, xpToNextLevel, attributePoints } = gameState.character;
            const xpPercentage = Math.min((xp / xpToNextLevel) * 100, 100);
            const isDay = gameState.time === 'day';

            const timeIcon = isDay
                ? `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-yellow-300" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.706-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 14.95l.707-.707a1 1 0 10-1.414-1.414l-.707.707a1 1 0 001.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 100 2h1z" clip-rule="evenodd" /></svg>`
                : `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-blue-300" viewBox="0 0 20 20" fill="currentColor"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z" /></svg>`;

            container.innerHTML = `
                <div class="flex justify-between items-start">
                    <div>
                        <h2 class="text-xl font-bold text-amber-400">${name}</h2>
                        <p class="text-sm text-gray-400">Level ${level} ${races[race].name} ${classes[characterClass].name}</p>
                    </div>
                    <div class="flex items-center gap-2 p-1 bg-gray-900 rounded-lg">
                        ${timeIcon}
                        <span class="font-bold text-sm ${isDay ? 'text-yellow-300' : 'text-blue-300'}">${isDay ? 'Day' : 'Night'}</span>
                    </div>
                </div>
                
                <div class="my-3">
                    <p class="text-sm font-bold flex justify-between"><span>Health</span> <span>${hp} / ${maxHp}</span></p>
                    <div class="w-full bg-gray-600 rounded-full h-4 mt-1">
                        <div class="bg-red-600 h-4 rounded-full" style="width: ${(hp / maxHp) * 100}%"></div>
                    </div>
                </div>
                 <div class="mb-4">
                    <p class="text-sm font-bold flex justify-between"><span>XP</span> <span>${xp} / ${xpToNextLevel}</span></p>
                    <div class="w-full bg-gray-600 rounded-full h-2.5 mt-1">
                        <div class="bg-blue-500 h-2.5 rounded-full" style="width: ${xpPercentage}%"></div>
                    </div>
                </div>
                
                ${ (attributePoints > 0) ? `
                    <div class="my-4">
                        <button id="level-up-btn" class="game-button w-full bg-amber-500 hover:bg-amber-400 text-black font-bold py-2 px-4 rounded text-lg level-up-button-glow">
                            LEVEL UP! (${attributePoints} Point${attributePoints > 1 ? 's' : ''})
                        </button>
                    </div>
                ` : ''}

                <h3 class="font-bold text-amber-500 mt-4 border-b border-gray-600 mb-2">S.P.E.C.I.A.L.</h3>
                <ul class="space-y-1">
                    ${AllStats.map(stat => `
                        <li class="flex justify-between items-center text-sm">
                            <span class="font-bold">${specialNames[stat]}</span>
                            <span class="px-2 py-0.5 bg-gray-700 rounded">${getPlayerStat(stat)}</span>
                        </li>
                    `).join('')}
                </ul>
                <h3 class="font-bold text-amber-500 mt-4 border-b border-gray-600 mb-2">Equipped</h3>
                <div id="equipped-items-list" class="space-y-1 text-sm"></div>
            `;
            renderEquippedItems();

            const levelUpBtn = document.getElementById('level-up-btn');
            if (levelUpBtn) {
                levelUpBtn.addEventListener('click', () => {
                    // Initialize temporary state for the level up screen
                    gameState.levelUpState = {
                        tempStats: { ...gameState.character.stats },
                        pointsToSpend: gameState.character.attributePoints,
                        originalPoints: gameState.character.attributePoints,
                    };
                    gameState.screen = 'levelUp';
                    render();
                });
            }
        }

        function renderEquippedItems() {
             const container = document.getElementById('equipped-items-list');
             if (!container) return;
             const slots = ['weapon', 'armor', 'gear'];
             container.innerHTML = slots.map(slot => {
                const itemId = gameState.character.equipped[slot];
                const item = itemId ? items[itemId] : null;
                return `
                     <div class="flex justify-between items-center">
                        <span class="capitalize text-gray-400">${slot}:</span>
                        <span class="text-right">${item ? item.name : 'None'}</span>
                    </div>
                `
             }).join('');
        }

        function renderInteractiveBox() {
            const container = document.getElementById('interactive-box');
            if (!container) return;
            container.innerHTML = `
                <div id="interactive-tabs" class="flex-shrink-0 flex border-b border-gray-700 mb-2">
                   <button data-tab="inventory" class="interactive-tab-button flex-1 p-3 text-sm font-bold bg-gray-900 hover:bg-gray-700">Inventory</button>
                   <button data-tab="quests" class="interactive-tab-button flex-1 p-3 text-sm font-bold bg-gray-900 hover:bg-gray-700">Quests</button>
                   <button data-tab="crew" class="interactive-tab-button flex-1 p-3 text-sm font-bold bg-gray-900 hover:bg-gray-700">Crew</button>
                </div>
                <div id="interactive-content" class="flex-grow flex min-h-0">
                   <!-- Content will be injected here -->
                </div>
                 <div id="player-input-container" class="flex-shrink-0 mt-4">
                    <button id="save-html-btn" class="game-button w-full bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-2 px-4 rounded">Save Game to HTML</button>
                </div>
            `;
            renderInteractiveContent(gameState.ui.activeTab);
        }

        function renderInteractiveContent(tab) {
            const contentEl = document.getElementById('interactive-content');
            if (!contentEl) return;

            // Update tab visuals
            document.querySelectorAll('.interactive-tab-button').forEach(btn => btn.classList.remove('active'));
            const activeBtn = document.querySelector(`.interactive-tab-button[data-tab="${tab}"]`);
            if (activeBtn) activeBtn.classList.add('active');

            // Set up two-pane layout with improved borders and background
            contentEl.innerHTML = `
                <div class="flex-grow flex min-h-0 border border-gray-700 rounded-md bg-gray-900/50">
                    <div id="interactive-list-pane" class="w-2/5 border-r border-gray-700 overflow-y-auto custom-scrollbar"></div>
                    <div id="interactive-detail-pane" class="w-3/5 p-3 overflow-y-auto custom-scrollbar"></div>
                </div>
            `;

            const listPane = document.getElementById('interactive-list-pane');
            const detailPane = document.getElementById('interactive-detail-pane');

            if (tab === 'inventory') {
                renderInventoryList(listPane);
                renderInventoryDetail(detailPane);
            } else if (tab === 'quests') {
                renderQuestList(listPane);
                renderQuestDetail(detailPane);
            } else if (tab === 'crew') {
                renderCrewList(listPane);
                renderCrewDetail(detailPane);
            }
        }
        
        function renderInventoryList(container) {
            container.innerHTML = `
                <div class="p-2 bg-gray-900">
                    <span class="font-bold text-yellow-500">Credits:</span>
                    <span class="font-bold text-lg text-yellow-300 float-right">${gameState.credits}</span>
                </div>
                <div id="inventory-list" class="space-y-0"></div>
            `;

            const listEl = document.getElementById('inventory-list');
            if (gameState.inventory.length === 0) {
                listEl.innerHTML = '<p class="p-2 text-gray-500 italic">Your pockets are empty.</p>';
                return;
            }

            gameState.inventory.forEach(invItem => {
                const itemData = items[invItem.id];
                const isSelected = gameState.ui.selectedInventoryId === invItem.id;
                const itemEl = document.createElement('div');
                itemEl.className = `interactive-list-item ${isSelected ? 'selected' : ''}`;
                itemEl.dataset.itemId = invItem.id;
                itemEl.innerHTML = `
                    <p class="font-bold text-amber-300">${itemData.name} ${invItem.quantity > 1 ? `(x${invItem.quantity})` : ''}</p>
                    <span class="text-xs capitalize text-gray-400">${itemData.type}</span>
                `;
                listEl.appendChild(itemEl);
            });
        }
        
        function renderInventoryDetail(container) {
            const selectedId = gameState.ui.selectedInventoryId;
            if (!selectedId || !gameState.inventory.some(i => i.id === selectedId)) {
                container.innerHTML = '<p class="text-gray-500 italic text-center mt-4">Select an item to see details.</p>';
                return;
            }
            
            const itemData = items[selectedId];
            let isEquipped = Object.values(gameState.character.equipped).includes(selectedId);

            let bonusHtml = '';
            if (itemData.bonus) {
                bonusHtml = Object.entries(itemData.bonus).map(([key, value]) => `
                    <span class="inline-block bg-gray-900 text-cyan-300 text-sm px-2 py-1 rounded">
                        ${key === 'defense' ? 'Defense' : specialNames[key]} +${value}
                    </span>
                `).join(' ');
            }
             if (itemData.effect?.type === 'heal') {
                 bonusHtml += `<span class="inline-block bg-gray-900 text-green-400 text-sm px-2 py-1 rounded">Heals ${itemData.effect.amount} HP</span>`;
             }

            let actionsHtml = '';
            if (itemData.type === 'consumable' && itemData.effect?.type === 'heal') {
                actionsHtml = `<button id="item-use-btn" class="game-button bg-green-600 hover:bg-green-500 font-bold py-2 px-4 rounded w-full">Use</button>`;
            }
            if (['weapon', 'armor', 'gear'].includes(itemData.type)) {
                 actionsHtml = `<button id="item-equip-btn" class="game-button bg-blue-600 hover:bg-blue-500 font-bold py-2 px-4 rounded w-full">${isEquipped ? 'Unequip' : 'Equip'}</button>`;
            }


            container.innerHTML = `
                <h3 class="text-lg font-bold text-amber-300 border-b border-gray-600 pb-2">${itemData.name}</h3>
                <p class="text-sm text-gray-400 my-3">${itemData.description}</p>
                <div class="my-4 space-x-2">${bonusHtml}</div>
                <div class="mt-auto pt-4 border-t border-gray-600">${actionsHtml}</div>
            `;
        }

        function renderQuestList(container) {
             const activeQuests = Object.values(gameState.quests).filter(q => !q.completed);
             const completedQuests = Object.values(gameState.quests).filter(q => q.completed);

             container.innerHTML = `
                <div class="p-2 bg-gray-900 font-bold text-amber-500">Active Quests</div>
                ${ activeQuests.length > 0 ? activeQuests.map(q => renderQuestListItem(q)).join('') : '<p class="p-2 text-gray-500 italic text-sm">No active quests.</p>' }
                
                <div class="mt-4 p-2 bg-gray-900 font-bold text-amber-500">Completed Quests</div>
                 ${ completedQuests.length > 0 ? completedQuests.map(q => renderQuestListItem(q)).join('') : '<p class="p-2 text-gray-500 italic text-sm">No completed quests.</p>' }
            `;
        }
        
        function renderQuestListItem(questState) {
            const questData = quests[questState.id];
            const isSelected = gameState.ui.selectedQuestId === questState.id;
            const completedClass = questState.completed ? 'line-through text-gray-500' : 'text-amber-300';
            
            return `
                <div class="interactive-list-item ${isSelected ? 'selected' : ''}" data-quest-id="${questState.id}">
                    <p class="font-bold ${completedClass}">${questData.name}</p>
                </div>
            `;
        }

        function renderQuestDetail(container) {
            const selectedId = gameState.ui.selectedQuestId;
            if (!selectedId || !gameState.quests[selectedId]) {
                container.innerHTML = '<p class="text-gray-500 italic text-center mt-4">Select a quest to see details.</p>';
                return;
            }
            const questState = gameState.quests[selectedId];
            const questData = quests[selectedId];
            const currentStageDescription = questData.stages[questState.stage].description;

            container.innerHTML = `
                <h3 class="text-lg font-bold text-amber-300 border-b border-gray-600 pb-2">${questData.name}</h3>
                
                ${!questState.completed ? `
                <div class="mt-4 p-3 bg-gray-900 rounded-md border border-gray-700">
                    <p class="text-sm font-bold text-cyan-300 mb-1">Current Objective:</p>
                    <p class="text-yellow-300">${currentStageDescription}</p>
                </div>` : ''}

                <div class="mt-4">
                    <p class="text-sm font-bold text-gray-400 mb-2">Quest Log:</p>
                    <ul class="space-y-3 border-l-2 border-gray-700 pl-4">
                        ${Object.entries(questData.stages)
                            .filter(([stageNum]) => parseInt(stageNum, 10) <= questState.stage)
                            .map(([stageNum, stageData]) => {
                                const stageIndex = parseInt(stageNum, 10);
                                let statusClass = ''; 
                                let icon = '';

                                if ((stageIndex < questState.stage) || questState.completed) {
                                    statusClass = 'text-gray-400 line-through'; // Completed
                                    icon = `<div class="w-3 h-3 bg-green-500 rounded-full absolute -left-[22px] top-1.5"></div>`;
                                } else if (stageIndex === questState.stage) {
                                    statusClass = 'text-white font-bold'; // Current
                                    icon = `<div class="w-3 h-3 bg-yellow-400 rounded-full absolute -left-[22px] top-1.5 animate-pulse"></div>`;
                                }
                                
                                return `<li class="text-sm relative ${statusClass}">${icon}${stageData.description}</li>`;
                        }).join('')}
                    </ul>
                </div>
            `;
        }

        function renderCrewList(container) {
            if (gameState.companions.length === 0) {
                container.innerHTML = '<p class="p-2 text-gray-500 italic">No active crew members.</p>';
                return;
            }
            container.innerHTML = gameState.companions.map(crewMemberState => {
                const companionData = companions[crewMemberState.id];
                const isSelected = gameState.ui.selectedCompanionId === crewMemberState.id;
                return `
                    <div class="interactive-list-item ${isSelected ? 'selected' : ''}" data-companion-id="${crewMemberState.id}">
                        <p class="font-bold text-amber-300">${companionData.name}</p>
                    </div>
                `;
            }).join('');
        }
        
        function renderCrewDetail(container) {
             const selectedId = gameState.ui.selectedCompanionId;
            if (!selectedId || !gameState.companions.some(c => c.id === selectedId)) {
                container.innerHTML = '<p class="text-gray-500 italic text-center mt-4">Select a crew member to see details.</p>';
                return;
            }

            const companionData = companions[selectedId];

            container.innerHTML = `
                <h3 class="text-lg font-bold text-amber-300 border-b border-gray-600 pb-2">${companionData.name}</h3>
                <p class="text-sm text-gray-400 my-3 italic">${companionData.description}</p>
                <div class="my-4">
                     <p class="text-sm font-bold flex justify-between"><span>Health</span> <span>${companionData.stats.HP} / ${companionData.stats.MaxHP}</span></p>
                    <div class="w-full bg-gray-600 rounded-full h-2.5 mt-1">
                        <div class="bg-red-600 h-2.5 rounded-full" style="width: ${(companionData.stats.HP / companionData.stats.MaxHP) * 100}%"></div>
                    </div>
                </div>
                <h4 class="font-bold text-amber-500 mt-4 border-b border-gray-700 mb-2">S.P.E.C.I.A.L.</h4>
                <ul class="grid grid-cols-2 gap-x-4 gap-y-1 text-sm">
                    ${AllStats.map(stat => `
                        <li class="flex justify-between">
                            <span class="font-bold">${specialNames[stat]}</span>
                            <span>${companionData.stats[stat]}</span>
                        </li>
                    `).join('')}
                </ul>
            `;
        }
        
        function populateLogFromState() {
            const logHistory = document.getElementById('log-history');
            if (logHistory) {
                logHistory.innerHTML = gameState.log.join('');
                logHistory.scrollTop = logHistory.scrollHeight;
            }
        }

        function renderLogAndInput() {
            const container = document.getElementById('log-box');
            if (!container) return;

            container.innerHTML = `
                <div id="log-history" class="custom-scrollbar"></div>
                <form id="command-form">
                    <span class="text-amber-400 text-lg mr-2">&gt;</span>
                    <input type="text" id="command-input" autocomplete="off" autofocus>
                </form>
            `;
            
            populateLogFromState();

            const formEl = document.getElementById('command-form');
            formEl.addEventListener('submit', (e) => {
                e.preventDefault();
                const inputEl = document.getElementById('command-input');
                const command = inputEl.value.trim();
                if (command) {
                    handleCommand(command);
                    inputEl.value = '';
                }
            });
            // Refocus input after any click, unless a modal is open
            document.body.addEventListener('click', () => {
                if (!gameState.modal) {
                     document.getElementById('command-input')?.focus();
                }
            });
             document.getElementById('command-input')?.focus();
        }

        function renderDialogueModal() {
            const container = document.getElementById('modal-container');
            if (!gameState.modal || !['dialogue', 'encounter'].includes(gameState.modal.type)) {
                container.innerHTML = '';
                return;
            }
            
            const isEncounter = gameState.modal.type === 'encounter';
            const { npcId, nodeId } = gameState.modal.context;
            const sourceData = isEncounter ? encounters[npcId] : npcs[npcId];
            const dialogueNode = sourceData.dialogue[nodeId];

            if (!dialogueNode) { // End of dialogue
                gameState.modal = null;
                if (!isEncounter) {
                    addToLog(`<p class="text-gray-500 italic">You finished the conversation with ${sourceData.name}.</p>`);
                }
                
                if (gameState.ui.pendingTravel) {
                    const destination = gameState.ui.pendingTravel;
                    delete gameState.ui.pendingTravel;
                    handleTravel(destination, true); // force travel, no new encounter
                } else {
                    render();
                }
                return;
            }

            container.innerHTML = `
                <div class="dialogue-modal-backdrop">
                    <div class="dialogue-modal-content">
                        <div class="dialogue-portrait-container">
                            ${ isEncounter ? '<div class="w-full h-full bg-black flex items-center justify-center"><p class="text-red-500 font-bold text-4xl font-title tracking-widest">[ENCOUNTER]</p></div>' : 
                                (gameState.ui.npcPortraits[npcId] 
                                    ? `<img src="${gameState.ui.npcPortraits[npcId]}" class="animate-fade-in" />`
                                    : `<div class="spinner"></div>`)
                            }
                        </div>
                        <div class="dialogue-main">
                             <h2 class="text-2xl font-bold text-cyan-400 mb-2">${sourceData.name}</h2>
                            <div id="dialogue-npc-text" class="custom-scrollbar"></div>
                            <div id="dialogue-choices" class="custom-scrollbar"></div>
                        </div>
                    </div>
                </div>
            `;

            let npcText = dialogueNode.npcText;
            if (dialogueNode.reactions) {
                const reaction = dialogueNode.reactions.find(r => {
                    if (r.condition.type === 'playerClass' && gameState.character.characterClass === r.condition.class) return true;
                    if (r.condition.type === 'hasItem' && gameState.inventory.some(i => i.id === r.condition.itemId)) return true;
                    if (r.condition.type === 'hasCompanion' && gameState.companions.some(c => c.id === r.condition.companionId)) return true;
                    return false;
                });
                if (reaction) {
                    npcText += ` <span class="text-cyan-300 italic">${reaction.npcText}</span>`;
                }
            }

            const textEl = document.getElementById('dialogue-npc-text');
            const choicesEl = document.getElementById('dialogue-choices');
            
            typeText(textEl, `<p>${npcText}</p>`, () => {
                if (dialogueNode.action) {
                    processAction(dialogueNode.action);
                    // If the action doesn't lead to another node, we might need to manually progress
                    const nextNodeId = dialogueNode.leadsTo;
                    if (nextNodeId) {
                        if (isEncounter) {
                            startEncounter(npcId, nextNodeId);
                        } else {
                            startDialogue(npcId, nextNodeId);
                        }
                    }
                } else if (dialogueNode.playerChoices && dialogueNode.playerChoices.length > 0) {
                    dialogueNode.playerChoices.forEach((choice, index) => {
                        let canChoose = true;
                        let disabledReason = '';
                        if (choice.condition) {
                            if (choice.condition.type === 'hasItem' && !gameState.inventory.some(i => i.id === choice.condition.itemId)) {
                                canChoose = false;
                            }
                            if (choice.condition.type === 'hasCredits' && gameState.credits < choice.condition.amount) {
                                canChoose = false;
                                disabledReason = ` (Requires ${choice.condition.amount} cr)`;
                            }
                        }
                        if(canChoose) {
                            const button = document.createElement('button');
                            button.className = 'dialogue-choice-button';
                            button.dataset.choiceIndex = index;
                            button.innerHTML = `&gt; ${choice.text}`;
                            button.addEventListener('click', () => handleDialogueChoice(index));
                            choicesEl.appendChild(button);
                        } else {
                            const disabledButton = document.createElement('button');
                            disabledButton.className = 'dialogue-choice-button';
                            disabledButton.disabled = true;
                            disabledButton.style.opacity = 0.5;
                            disabledButton.style.cursor = 'not-allowed';
                            disabledButton.innerHTML = `&gt; ${choice.text} <span class="text-red-400">${disabledReason}</span>`;
                            choicesEl.appendChild(disabledButton);
                        }
                    });
                }
            });
        }
        
        function renderCombatModal() {
            const container = document.getElementById('modal-container');
            if (!gameState.modal || gameState.modal.type !== 'combat') {
                container.innerHTML = '';
                return;
            }
            const { player, companion, enemy, turn, log } = gameState.modal.context;

            const renderParticipantStatus = (participant, type, isActive) => {
                if (!participant) return '';
                const name = (type === 'player' || type === 'companion') ? participant.name : enemies[participant.id].name;
                 const maxHp = (type === 'player' || type === 'companion') ? participant.maxHp : enemies[participant.id].stats.MaxHP;
                const hp = participant.hp;
                return `
                    <div class="combat-status-display ${type} ${isActive ? 'active-turn' : ''}">
                        <p class="font-bold text-lg ${isActive ? 'text-amber-400' : 'text-white'}">${name}</p>
                        <div class="w-full bg-gray-600 rounded-full h-3 mt-1">
                            <div class="bg-red-600 h-3 rounded-full" style="width: ${(hp / maxHp) * 100}%"></div>
                        </div>
                        <p class="text-right text-xs">${hp} / ${maxHp}</p>
                    </div>
                `;
            };

            container.innerHTML = `
                <div class="combat-modal-backdrop">
                    <div class="combat-modal-content">
                        <div class="combat-background"></div>
                        <div class="combat-vignette"></div>
                        <div id="combat-popups"></div>
                        
                        ${renderParticipantStatus(player, 'player', turn === 'player')}
                        ${renderParticipantStatus(companion, 'companion', turn === 'companion')}
                        ${renderParticipantStatus(enemy, 'enemy', turn === 'enemy')}
                        
                        <div class="p-4 text-sm text-gray-400 absolute top-0 left-0 w-1/2 h-2/3 overflow-y-auto custom-scrollbar">
                           ${log.map(entry => `<p>${entry}</p>`).join('')}
                           <span class="blinking-cursor">_</span>
                        </div>
                        
                        <div class="combat-action-bar">
                            <button data-combat-action="attack" class="game-button bg-red-700 hover:bg-red-600 text-white font-bold py-2 px-4 rounded" ${turn !== 'player' ? 'disabled' : ''}>Attack</button>
                            <button data-combat-action="use_item" class="game-button bg-blue-700 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded" ${turn !== 'player' ? 'disabled' : ''}>Use Item</button>
                            <button data-combat-action="flee" class="game-button bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded" ${turn !== 'player' ? 'disabled' : ''}>Flee</button>
                        </div>
                    </div>
                </div>
            `;
            // Re-attach combat listeners specifically
             document.querySelectorAll('.combat-action-bar button').forEach(button => {
                button.addEventListener('click', e => handleCombatAction(e.currentTarget.dataset.combatAction));
            });
        }

        function renderVendorModal() {
            const container = document.getElementById('modal-container');
            if (!gameState.modal || gameState.modal.type !== 'vendor') {
                container.innerHTML = '';
                return;
            }
            const { vendorId, activeTab, selectedItem } = gameState.modal.context;
            const vendor = vendors[vendorId];

            container.innerHTML = `
                <div class="vendor-modal-backdrop">
                    <div class="vendor-modal-content">
                        <img src="https://storage.googleapis.com/aistudio-public/projects/meet-gemini/2-24/convo-background-3.jpg" class="vendor-background" />
                        <div class="vendor-header">
                            <h2 class="text-2xl font-bold text-amber-400 font-title">${vendor.name}</h2>
                            <p class="text-sm text-gray-400">Your Credits: <span class="font-bold text-yellow-300">${gameState.credits}</span></p>
                            <button id="vendor-close-btn" class="absolute top-2 right-3 text-2xl font-bold text-gray-400 hover:text-white">&times;</button>
                        </div>
                        <div class="vendor-main">
                            <div class="vendor-item-list">
                                <div class="vendor-tabs">
                                    <div class="vendor-tab ${activeTab === 'buy' ? 'active' : ''}" data-tab="buy">Buy</div>
                                    <div class="vendor-tab ${activeTab === 'sell' ? 'active' : ''}" data-tab="sell">Sell</div>
                                </div>
                                <div id="vendor-item-list-content" class="vendor-item-list-content custom-scrollbar"></div>
                            </div>
                            <div id="vendor-item-detail-view" class="vendor-item-detail">
                                <!-- Item details will be rendered here -->
                            </div>
                        </div>
                    </div>
                </div>
            `;

            renderVendorItemList();
            if (selectedItem) {
                renderVendorItemDetail(selectedItem);
            } else {
                 document.getElementById('vendor-item-detail-view').innerHTML = `<p class="text-gray-500">Select an item to see details.</p>`;
            }
            attachVendorListeners();
        }
        
        function renderSabaccModal() {
            const container = document.getElementById('modal-container');
            if (!gameState.modal || gameState.modal.type !== 'sabacc') {
                container.innerHTML = '';
                return;
            }
            const { pot, playerHand, dealerHand, message, phase } = gameState.modal.context;
            
            const renderHand = (hand, isPlayer, isHidden) => {
                return hand.map(card => `
                    <div class="sabacc-card-slot">
                        <div class="sabacc-card ${isHidden ? 'hidden' : ''}">
                            ${isHidden ? '?' : card}
                        </div>
                    </div>
                `).join('');
            };

            container.innerHTML = `
                <div class="sabacc-modal-backdrop">
                    <div class="sabacc-modal-content">
                        <h2 class="text-center text-3xl font-bold font-title text-orange-300">Sabacc</h2>
                        
                        <div class="sabacc-hand-area">
                            <span class="sabacc-hand-label dealer">Dealer's Hand</span>
                            ${renderHand(dealerHand, false, phase !== 'end')}
                        </div>

                        <div class="sabacc-pot-display">
                            <div class="pot-label">SABACC POT</div>
                            <div class="pot-amount">${pot} cr</div>
                        </div>

                        <div class="sabacc-hand-area">
                             <span class="sabacc-hand-label player">Your Hand (Total: ${phase === 'end' ? calculateSabaccHand(playerHand) : '?'})</span>
                            ${renderHand(playerHand, true, false)}
                        </div>

                        <div class="sabacc-message text-center font-bold">${message}</div>

                        <div id="sabacc-actions" class="flex justify-center gap-4 mt-2"></div>
                    </div>
                </div>
            `;
            
            const actionsContainer = document.getElementById('sabacc-actions');
            if (phase === 'betting') {
                 actionsContainer.innerHTML = `
                    <button class="game-button bg-green-600 hover:bg-green-500 text-white font-bold py-2 px-4 rounded" data-sabacc-action="bet" data-amount="10">Bet 10</button>
                    <button class="game-button bg-green-700 hover:bg-green-600 text-white font-bold py-2 px-4 rounded" data-sabacc-action="bet" data-amount="25">Bet 25</button>
                    <button class="game-button bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded" data-sabacc-action="fold">Fold</button>
                `;
            } else if (phase === 'playing') {
                actionsContainer.innerHTML = `
                    <button class="game-button bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-4 rounded" data-sabacc-action="hit">Hit</button>
                    <button class="game-button bg-yellow-600 hover:bg-yellow-500 text-white font-bold py-2 px-4 rounded" data-sabacc-action="stand">Stand</button>
                `;
            } else if (phase === 'end') {
                actionsContainer.innerHTML = `
                    <button class="game-button bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-2 px-4 rounded" data-sabacc-action="play_again">Play Again</button>
                    <button class="game-button bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded" data-sabacc-action="leave">Leave Table</button>
                `;
            }
             // Re-attach sabacc listeners specifically
             document.querySelectorAll('#sabacc-actions button').forEach(button => {
                 button.addEventListener('click', e => {
                    const action = e.currentTarget.dataset.sabaccAction;
                    const amount = e.currentTarget.dataset.amount;
                    handleSabaccAction(action, parseInt(amount));
                });
            });
        }
        
        function renderHoloNetModal() {
            const container = document.getElementById('modal-container');
            if (!gameState.modal || gameState.modal.type !== 'holonet') {
                container.innerHTML = '';
                return;
            }
            const { selectedStoryId } = gameState.modal.context;

            container.innerHTML = `
                <div class="holonet-modal-backdrop">
                    <div class="holonet-modal-content">
                        <div class="holonet-header">
                            <h2 class="text-2xl font-bold text-sky-300 tracking-widest">TATOOINE HOLONET NEWS</h2>
                            <p class="text-xs text-sky-500">Your Source for Outer Rim Intelligence</p>
                            <button id="holonet-close-btn" class="absolute top-2 right-3 text-2xl font-bold text-gray-400 hover:text-white">&times;</button>
                        </div>
                        <div class="holonet-main">
                            <div id="holonet-story-list-content" class="holonet-story-list custom-scrollbar"></div>
                            <div id="holonet-story-detail-view" class="holonet-story-detail custom-scrollbar"></div>
                        </div>
                    </div>
                </div>
            `;
            
            const listEl = document.getElementById('holonet-story-list-content');
            listEl.innerHTML = gameState.holonetNews.map(storyId => {
                const story = holonetStories[storyId];
                const isSelected = selectedStoryId === storyId;
                return `
                    <div class="holonet-story-entry ${isSelected ? 'selected' : ''}" data-story-id="${storyId}">
                        <h3 class="font-bold text-sky-400">${story.headline}</h3>
                    </div>
                `;
            }).join('');

            const detailEl = document.getElementById('holonet-story-detail-view');
            if (selectedStoryId) {
                const story = holonetStories[selectedStoryId];
                detailEl.innerHTML = `
                    <h2 class="text-xl font-bold text-sky-300 mb-4 border-b border-sky-700 pb-2">${story.headline}</h2>
                    <p class="text-base font-sans leading-relaxed whitespace-pre-wrap">${story.content}</p>
                `;
            } else {
                detailEl.innerHTML = `<p class="text-sky-400 italic text-center mt-8">Select a headline to read the story.</p>`;
            }

            attachHoloNetListeners();
        }


        // --- EVENT HANDLERS & COMMANDS ---
        function attachUIEventListeners() {
            // Event Delegation for Interactive Box
            const interactiveBox = document.getElementById('interactive-box');
            if (interactiveBox) {
                interactiveBox.addEventListener('click', (e) => {
                    if (gameState.ui.isTyping) return;

                    // Tab Buttons
                    const tabButton = e.target.closest('.interactive-tab-button');
                    if (tabButton) {
                        const tab = tabButton.dataset.tab;
                        gameState.ui.activeTab = tab;
                        gameState.ui.selectedInventoryId = null;
                        gameState.ui.selectedQuestId = null;
                        gameState.ui.selectedCompanionId = null;
                        renderInteractiveContent(tab);
                        return;
                    }

                    // List Items
                    const listItem = e.target.closest('.interactive-list-item');
                    if (listItem) {
                        if (listItem.dataset.itemId) {
                            gameState.ui.selectedInventoryId = listItem.dataset.itemId;
                        } else if (listItem.dataset.questId) {
                            gameState.ui.selectedQuestId = listItem.dataset.questId;
                        } else if (listItem.dataset.companionId) {
                            gameState.ui.selectedCompanionId = listItem.dataset.companionId;
                        }
                        renderInteractiveContent(gameState.ui.activeTab);
                        return;
                    }

                    // Detail Pane Action Buttons
                    const useButton = e.target.closest('#item-use-btn');
                    if (useButton) {
                        useItem(gameState.ui.selectedInventoryId);
                        return;
                    }

                    const equipButton = e.target.closest('#item-equip-btn');
                    if (equipButton) {
                        toggleEquipItem(gameState.ui.selectedInventoryId);
                        return;
                    }
                    
                    // Save HTML Button
                    const saveBtn = e.target.closest('#save-html-btn');
                    if (saveBtn) {
                        saveGameAsHtml();
                        return;
                    }
                });
            }
        }

        function parseCommand(commandStr) {
            const verbs = {
                'talk': ['talk', 'speak', 'ask', 'report'],
                'go': ['go', 'travel', 'move', 'enter', 'head', 'leave', 'return', 'explore', 'slip', 'investigate', 'venture', 'visit', 'find', 'search', 'follow'],
                'buy': ['buy', 'purchase', 'get'],
                'trade': ['trade', 'barter'],
                'play': ['play'],
                'check': ['check', 'look at'],
                'access': ['access', 'use', 'open'],
                'rest': ['rest']
            };

            const str = commandStr.toLowerCase().replace(/to |with |at |into |a /g, '').trim();
            const words = str.split(' ');
            const verb = words[0];
            const target = words.slice(1).join(' ');

            for (const canonicalVerb in verbs) {
                if (verbs[canonicalVerb].includes(verb)) {
                    return { verb: canonicalVerb, target: target };
                }
            }
            return { verb: null, target: str }; // Return the whole string if no verb found
        }
        
        function handleCommand(commandString) {
            if (gameState.ui.isTyping) return;
            addToLog(`<p class="text-gray-500 italic">&gt; ${commandString}</p>`);
            
            // Handle special commands first
            const specialCommands = ['help', 'save', 'clear', 'look', 'look around'];
            if (specialCommands.includes(commandString.toLowerCase().trim())) {
                switch (commandString.toLowerCase().trim()) {
                    case 'look': case 'look around': displayCurrentLocation(); return;
                    case 'help': displayHelp(); return;
                    case 'save': saveGame(); return;
                    case 'clear': 
                        gameState.log = [];
                        document.getElementById('log-history').innerHTML = '';
                        displayCurrentLocation();
                        return;
                }
            }

            const parsed = parseCommand(commandString);
            let actionFound = false;

            for (const availableAction of gameState.ui.availableActions) {
                const actionText = availableAction.text.toLowerCase();
                const actionObject = availableAction.action;
                let match = false;
                
                // Try direct match first
                if (actionText === commandString.toLowerCase()) {
                    match = true;
                }
                // Then try parsed match
                else if (parsed.verb) {
                    if (parsed.verb === 'talk' && actionObject.type === 'talk') {
                        const npcName = npcs[actionObject.npcId].name.toLowerCase();
                        if (npcName.includes(parsed.target)) match = true;
                    }
                    else if (parsed.verb === 'report' && actionObject.type === 'talk') { // Specific for quest turn-ins
                        const npcName = npcs[actionObject.npcId].name.toLowerCase();
                         if (npcName.includes(parsed.target) && actionText.includes("report")) match = true;
                    }
                    else if (parsed.verb === 'go' && actionObject.target) {
                        const locationName = locations[actionObject.target]?.name.toLowerCase() || '';
                         if (actionText.includes(parsed.target) || locationName.includes(parsed.target)) match = true;
                    }
                    else if (parsed.verb === 'buy' && actionObject.action?.type === 'buyItem') {
                         const itemName = items[actionObject.action.itemId].name.toLowerCase();
                         if (itemName.includes(parsed.target)) match = true;
                    }
                    else if (parsed.verb === 'trade' && actionObject.action?.type === 'trade') {
                         const vendorName = vendors[actionObject.action.vendorId]?.name.toLowerCase();
                         if (vendorName && (vendorName.includes(parsed.target) || actionText.includes(parsed.target))) match = true;
                    }
                     else if (actionText.includes(parsed.verb) && actionText.includes(parsed.target)) {
                        match = true;
                    }
                }

                if (match) {
                    actionFound = true;
                    if (actionObject.type === 'talk') {
                        startDialogue(actionObject.npcId, actionObject.nodeId);
                    } else if (actionObject.target) {
                        let finalTarget = actionObject.target;
                        if (finalTarget === 'swoop_garage' && gameState.flags.player_owns_garage) {
                            finalTarget = 'player_safehouse_garage';
                        }
                        handleTravel(finalTarget);
                    } else if (actionObject.action) {
                        const action = actionObject.action;
                         switch (action.type) {
                            case 'buyItem':
                                processAction(action);
                                render();
                                break;
                            case 'trade':
                                startTrade(action.vendorId);
                                break;
                            case 'sabacc':
                            case 'bounty_board':
                                playSabacc(action.ante);
                                break;
                            case 'rest':
                                processAction(action);
                                render();
                                break;
                            case 'holonet':
                                startHoloNet();
                                break;
                            default:
                                processAction(action);
                                break;
                        }
                    }
                    break; 
                }
            }

            if (!actionFound) {
                addToLog(`<p class="text-red-400">That's not a valid action. Type 'help' for commands.</p>`);
            }
        }
        
        function useItem(itemId) {
            if (!itemId) return;
            const itemData = items[itemId];
            if (!itemData || itemData.type !== 'consumable') return;

            if (itemData.effect?.type === 'heal') {
                const char = gameState.character;
                const healAmount = itemData.effect.amount;
                const oldHp = char.hp;
                char.hp = Math.min(char.maxHp, char.hp + healAmount);
                const actualHeal = char.hp - oldHp;
                if (actualHeal > 0) {
                    addToLog(`<p class="text-green-300">You use a ${itemData.name} and recover ${actualHeal} health.</p>`);
                } else {
                    addToLog(`<p class="text-gray-400">You use a ${itemData.name}, but you're already at full health.</p>`);
                }
                
                removeItemFromInventory(itemId, 1);
                gameState.ui.selectedInventoryId = null; // Deselect after use
                
                renderCharacterSheet(document.getElementById('character-sheet-box'));
                renderInteractiveContent('inventory');
            }
        }

        function toggleEquipItem(itemId) {
            if (!itemId) return;
            const itemData = items[itemId];
            if (!itemData.slot) return;

            const slot = itemData.slot;
            const currentlyEquipped = gameState.character.equipped[slot];
            
            if (currentlyEquipped === itemId) { // Unequip
                gameState.character.equipped[slot] = null;
                addToLog(`<p class="text-gray-400">You unequipped the ${itemData.name}.</p>`);
            } else { // Equip
                gameState.character.equipped[slot] = itemId;
                addToLog(`<p class="text-cyan-300">You equipped the ${itemData.name}.</p>`);
            }
            
            // Re-render relevant UI
            renderCharacterSheet(document.getElementById('character-sheet-box'));
            renderInteractiveContent('inventory');
        }

        function handleDialogueChoice(index) {
            const isEncounter = gameState.modal.type === 'encounter';
            const { npcId, nodeId } = gameState.modal.context;
            const sourceData = isEncounter ? encounters[npcId] : npcs[npcId];
            const node = sourceData.dialogue[nodeId];
            const choice = node.playerChoices[index];

            if (choice.action) {
                processAction(choice.action);
            }
            if (choice.leadsTo) {
                if (isEncounter) {
                    startEncounter(npcId, choice.leadsTo);
                } else {
                    startDialogue(npcId, choice.leadsTo);
                }
            }
        }
        
        function handleCombatAction(action) {
            if (gameState.ui.isTyping) return;
            switch(action) {
                case 'attack':
                    const playerDamage = calculateDamage(gameState.character, gameState.modal.context.enemy);
                    gameState.modal.context.enemy.hp -= playerDamage;
                    gameState.modal.context.log.push(`You hit ${gameState.modal.context.enemy.name} for ${playerDamage} damage.`);
                    createDamagePopup(playerDamage, 'enemy');

                    if (checkCombatEnd()) return;

                    gameState.modal.context.turn = gameState.modal.context.companion ? 'companion' : 'enemy';
                    renderCombatModal();
                    setTimeout(runNonPlayerTurns, 1000);
                    break;
                case 'flee':
                     if (Math.random() < 0.5) { 
                        gameState.modal.context.log.push("You successfully escaped!");
                        setTimeout(() => {
                           gameState.modal = null;
                           addToLog('<p class="text-gray-400">You fled from combat.</p>');
                           if (gameState.ui.pendingTravel) {
                                const destination = gameState.ui.pendingTravel;
                                delete gameState.ui.pendingTravel;
                                handleTravel(destination, true); // force travel
                            } else {
                                render();
                            }
                        }, 1500);
                     } else {
                        gameState.modal.context.log.push("You failed to escape!");
                        gameState.modal.context.turn = gameState.modal.context.companion ? 'companion' : 'enemy';
                        setTimeout(runNonPlayerTurns, 1000);
                     }
                     renderCombatModal();
                    break;
            }
        }

        function handleVendorAction() {
            if (gameState.ui.isTyping) return;
            const { activeTab, selectedItem } = gameState.modal.context;
            if (!selectedItem) return;

            const itemData = items[selectedItem];

            if (activeTab === 'buy') {
                if (gameState.credits >= itemData.value) {
                    gameState.credits -= itemData.value;
                    addItemToInventory(selectedItem);
                } else {
                    return;
                }
            } else { // sell
                gameState.credits += Math.floor(itemData.value * 0.5); // Sell for 50%
                removeItemFromInventory(selectedItem);
            }
            
            gameState.modal.context.selectedItem = null;
            renderVendorModal();
        }
        
        function handleSabaccAction(action, amount) {
            if (gameState.ui.isTyping) return;
            const context = gameState.modal.context;
            
            switch (action) {
                case 'bet':
                    if (gameState.credits >= amount) {
                        gameState.credits -= amount;
                        context.pot += amount * 2; // Dealer matches
                        context.phase = 'playing';
                        context.message = 'Your turn. Hit or Stand?';
                        renderSabaccModal();
                    } else {
                        context.message = "You can't afford that bet!";
                        renderSabaccModal();
                    }
                    break;
                case 'fold':
                     context.message = 'You folded. You lose your ante.';
                     context.phase = 'end';
                     renderSabaccModal();
                    break;
                case 'hit':
                    context.playerHand.push(drawSabaccCard());
                    if (calculateSabaccHand(context.playerHand) > 23) {
                        endSabaccRound('You bombed out! Dealer wins.');
                    } else {
                        renderSabaccModal();
                    }
                    break;
                case 'stand':
                    dealerSabaccTurn();
                    break;
                case 'play_again':
                    playSabacc(context.ante);
                    break;
                case 'leave':
                    gameState.modal = null;
                    render();
                    break;
            }
        }
        
        // --- START/END MODAL FUNCTIONS ---
        function startDialogue(npcId, nodeId = 'start') {
            if (gameState.ui.isTyping) return;
            const npc = npcs[npcId];
            if (!npc) return;

            let finalNodeId = nodeId;

            // If this is the start of a conversation, check for quest states to redirect dialogue
            if (nodeId === 'start' && npc.dialogueQuestChecks) {
                for (const check of npc.dialogueQuestChecks) {
                    const questState = gameState.quests[check.questId];
                    if (questState) {
                        const questData = quests[check.questId];
                        const lastStage = Object.keys(questData.stages).length - 1;
                        
                        if (questState.stage >= lastStage && questState.completed) {
                            finalNodeId = check.completedNode;
                            break;
                        } else {
                            finalNodeId = check.activeNode;
                            break;
                        }
                    }
                }
            }

            if (!npc.dialogue) {
                 addToLog(`<p class="text-cyan-400 font-bold">${npc.name}</p><p class="text-gray-400 italic">${npc.description}</p>`);
                 return;
            }
            
            const dialogueNode = npc.dialogue[finalNodeId];

             if (!dialogueNode) { // End of dialogue
                gameState.modal = null;
                addToLog(`<p class="text-gray-500 italic">You finished the conversation with ${npc.name}.</p>`);
                
                if (gameState.ui.pendingTravel) {
                    const destination = gameState.ui.pendingTravel;
                    delete gameState.ui.pendingTravel;
                    handleTravel(destination, true); // force travel
                }
                render();
                return;
            }
            
            gameState.modal = { type: 'dialogue', context: { npcId, nodeId: finalNodeId } };
            
            if (!gameState.ui.npcPortraits[npcId]) {
                generateNpcPortrait(npcId);
            }
            
            render();
        }

        function startEncounter(encounterId, nodeId = 'start') {
            if (gameState.ui.isTyping) return;
            const encounter = encounters[encounterId];
            if (!encounter) return;

            gameState.modal = { type: 'encounter', context: { npcId: encounterId, nodeId: nodeId } };
            render();
        }

        function handleTravel(targetLocationId, force = false) {
            let possibleEncounters = [];
            const toLocation = locations[targetLocationId];

            if (toLocation.id.includes('mos_eisley')) {
                possibleEncounters.push('imperial_patrol');
            }
            if (toLocation.id.includes('jundland') || toLocation.id.includes('homestead') || toLocation.id.includes('hut')) {
                possibleEncounters.push('tusken_raider_ambush');
            }

            const encounterChance = 0.1; // 10% chance
            if (!force && possibleEncounters.length > 0 && Math.random() < encounterChance) {
                const encounterId = getRandomElement(possibleEncounters);
                gameState.ui.pendingTravel = targetLocationId; 
                startEncounter(encounterId);
            } else {
                gameState.locationId = targetLocationId;
                gameState.ui.justMoved = true;
                render();
            }
        }

        function startCombat(enemyId) {
            const enemyData = enemies[enemyId];
            gameState.modal = {
                type: 'combat',
                context: {
                    player: { ...gameState.character }, // make copies
                    companion: gameState.companions.length > 0 ? { ...companions[gameState.companions[0].id] } : null,
                    enemy: { id: enemyId, hp: enemyData.stats.HP, name: enemyData.name }, // copy with HP
                    turn: 'player',
                    log: [`Combat started with ${enemyData.name}!`]
                }
            };
            renderCombatModal();
        }
        
        function startTrade(vendorId) {
            gameState.modal = {
                type: 'vendor',
                context: {
                    vendorId: vendorId,
                    activeTab: 'buy',
                    selectedItem: null,
                }
            };
            renderVendorModal();
        }
        
        function startHoloNet() {
            gameState.modal = {
                type: 'holonet',
                context: {
                    selectedStoryId: gameState.holonetNews[0] || null
                }
            };
            render();
        }

        // --- SUB-RENDERING & LOGIC (for complex modals) ---
        function calculateDamage(attacker, defender) {
            const attackPower = getPlayerStat('S'); // Assuming Strength for now
            return Math.max(1, Math.floor(Math.random() * 5) + attackPower - 2);
        }
        
        function createDamagePopup(amount, targetType) {
            const container = document.getElementById('combat-popups');
            if (!container) return;
            const popup = document.createElement('div');
            popup.className = 'damage-popup';
            popup.textContent = amount;
            
            const targetEl = document.querySelector(`.combat-status-display.${targetType}`);
            if (targetEl) {
                const rect = targetEl.getBoundingClientRect();
                const modalRect = container.closest('.combat-modal-content').getBoundingClientRect();
                popup.style.left = `${rect.left - modalRect.left + rect.width / 2}px`;
                popup.style.top = `${rect.top - modalRect.top + rect.height / 2}px`;
            }
            
            container.appendChild(popup);
            setTimeout(() => popup.remove(), 1500);
            
            const modalContent = container.closest('.combat-modal-content');
            modalContent.classList.add('shake-animation');
            setTimeout(() => modalContent.classList.remove('shake-animation'), 300);

            if (targetType === 'player' || targetType === 'companion') {
                const flash = document.createElement('div');
                flash.className = 'screen-flash';
                modalContent.appendChild(flash);
                setTimeout(() => flash.remove(), 400);
            }
        }

        function checkCombatEnd() {
            const context = gameState.modal.context;
            if (context.enemy.hp <= 0) {
                // VICTORY
                const mainEnemy = enemies[context.enemy.id];
                context.log.push(`You defeated ${mainEnemy.name}!`);
                context.turn = 'end';
                
                let totalXp = mainEnemy.xpValue || 0;
                if (mainEnemy.allies) {
                    mainEnemy.allies.forEach(allyId => {
                        totalXp += enemies[allyId].xpValue;
                    });
                }
                gainXP(totalXp);
                
                if (mainEnemy.victoryAction) {
                    processAction(mainEnemy.victoryAction);
                }

                if (mainEnemy.loot) {
                    mainEnemy.loot.forEach(itemId => addItemToInventory(itemId));
                }
                
                // Special narrative for Valerius
                if (mainEnemy.id === 'commander_valerius') {
                    addToLog('<p class="text-yellow-400 italic">As the commander falls, his form flickers and dissolves - a sophisticated hologram! He escaped, but in his haste to activate the projection, he dropped his physical code cylinder.</p>')
                }

                setTimeout(() => {
                    gameState.modal = null;
                    gameState.character.hp = context.player.hp;
                    
                    if (gameState.ui.pendingTravel) {
                        const destination = gameState.ui.pendingTravel;
                        delete gameState.ui.pendingTravel;
                        handleTravel(destination, true); // force travel
                    } else {
                         render();
                    }
                    addToLog(`<p class="text-green-400">You are victorious!</p>`);
                }, 2000);
                renderCombatModal();
                return true;
            }
            if (context.player.hp <= 0) {
                // DEFEAT
                context.log.push(`You have been defeated!`);
                context.turn = 'end';
                 setTimeout(() => {
                    gameState.modal = null;
                    gameState.character.hp = 1;
                    gameState.locationId = 'mos_eisley_cantina';
                    delete gameState.ui.pendingTravel;
                    render();
                    addToLog(`<p class="text-red-500">You have been defeated. You wake up later, your head throbbing and pockets lighter.</p>`)
                }, 3000);
                renderCombatModal();
                return true;
            }
            return false;
        }

        function runNonPlayerTurns() {
            if (checkCombatEnd()) return;
            const context = gameState.modal.context;

            if (context.turn === 'companion' && context.companion && context.companion.hp > 0) {
                const companionDamage = calculateDamage(context.companion, context.enemy);
                context.enemy.hp -= companionDamage;
                context.log.push(`${context.companion.name} hits ${context.enemy.name} for ${companionDamage} damage.`);
                createDamagePopup(companionDamage, 'enemy');
                context.turn = 'enemy';
                renderCombatModal();
                if (checkCombatEnd()) return;
                setTimeout(runNonPlayerTurns, 1500);
            } else if (context.turn === 'enemy') {
                const target = (!context.companion || context.companion.hp <= 0 || Math.random() > 0.5) ? 'player' : 'companion';
                const enemyDamage = calculateDamage(enemies[context.enemy.id], target === 'player' ? context.player : context.companion);

                if (target === 'player') {
                    context.player.hp -= enemyDamage;
                    context.log.push(`${context.enemy.name} hits you for ${enemyDamage} damage.`);
                     createDamagePopup(enemyDamage, 'player');
                } else {
                    context.companion.hp -= enemyDamage;
                    context.log.push(`${context.enemy.name} hits ${context.enemy.name} for ${enemyDamage} damage.`);
                     createDamagePopup(enemyDamage, 'companion');
                }
                
                context.turn = 'player';
                renderCombatModal();
                checkCombatEnd();
            } else { // case where companion was turn but is null/dead
                context.turn = 'enemy';
                runNonPlayerTurns();
            }
        }
        
        function closeVendorModal() {
            gameState.modal = null;
            render();
        }

        function switchVendorTab(tab) {
            gameState.modal.context.activeTab = tab;
            gameState.modal.context.selectedItem = null;
            renderVendorModal();
        }

        function selectVendorItem(itemId) {
            gameState.modal.context.selectedItem = itemId;
            renderVendorModal();
        }
        
        function renderVendorItemList() {
            const { vendorId, activeTab } = gameState.modal.context;
            const listContentEl = document.getElementById('vendor-item-list-content');
            let list = [];

            if (activeTab === 'buy') {
                list = vendors[vendorId].inventory;
            } else { // sell
                list = gameState.inventory.map(i => i.id);
            }

            if(list.length === 0) {
                listContentEl.innerHTML = `<p class="p-4 text-gray-500 italic">Nothing to show.</p>`;
                return;
            }

            listContentEl.innerHTML = list.map(itemId => {
                const itemData = items[itemId];
                const cantAfford = activeTab === 'buy' && itemData.value > gameState.credits;
                const isSelected = gameState.modal.context.selectedItem === itemId;
                
                return `
                    <div class="vendor-item-entry ${cantAfford ? 'cant-afford' : ''} ${isSelected ? 'selected' : ''}" data-item-id="${itemId}">
                        <span>${itemData.name}</span>
                        <span class="text-yellow-400">${activeTab === 'buy' ? itemData.value : Math.floor(itemData.value * 0.5)} cr</span>
                    </div>
                `;
            }).join('');
        }
        
        function renderVendorItemDetail() {
            const detailViewEl = document.getElementById('vendor-item-detail-view');
            const { activeTab, selectedItem } = gameState.modal.context;
            if (!selectedItem) {
                detailViewEl.innerHTML = `<p class="text-gray-500">Select an item to see details.</p>`;
                return;
            }

            const itemData = items[selectedItem];
            const actionText = activeTab === 'buy' ? 'Buy' : 'Sell';
            const price = activeTab === 'buy' ? itemData.value : Math.floor(itemData.value * 0.5);
            const canAfford = activeTab === 'buy' ? gameState.credits >= price : true;

            detailViewEl.innerHTML = `
                <h3 class="text-xl font-bold text-amber-300">${itemData.name}</h3>
                <p class="text-gray-400 text-sm capitalize my-2">(${itemData.type})</p>
                <p class="text-center text-gray-300 mb-4">${itemData.description}</p>
                <div class="my-4 text-center">
                    ${itemData.bonus ? Object.entries(itemData.bonus).map(([key, value]) => `
                        <span class="inline-block bg-gray-900 text-cyan-300 text-sm px-2 py-1 rounded">
                            ${key === 'defense' ? 'Defense' : specialNames[key]} +${value}
                        </span>
                    `).join(' ') : ''}
                </div>
                <button id="vendor-action-button" class="game-button bg-green-600 hover:bg-green-500 font-bold py-2 px-6 rounded" ${!canAfford ? 'disabled' : ''}>
                    ${actionText} for ${price} credits
                </button>
            `;
        }

        function attachVendorListeners() {
            document.getElementById('vendor-close-btn')?.addEventListener('click', closeVendorModal);
            document.querySelectorAll('.vendor-tab').forEach(tab => {
                tab.addEventListener('click', (e) => switchVendorTab(e.currentTarget.dataset.tab));
            });
            document.querySelectorAll('.vendor-item-entry').forEach(entry => {
                entry.addEventListener('click', (e) => selectVendorItem(e.currentTarget.dataset.itemId));
            });
            document.getElementById('vendor-action-button')?.addEventListener('click', handleVendorAction);
        }
        
        function attachHoloNetListeners() {
            document.getElementById('holonet-close-btn')?.addEventListener('click', () => {
                gameState.modal = null;
                render();
            });
            document.querySelectorAll('.holonet-story-entry').forEach(entry => {
                entry.addEventListener('click', (e) => {
                    gameState.modal.context.selectedStoryId = e.currentTarget.dataset.storyId;
                    renderHoloNetModal();
                });
            });
        }

        function playSabacc(ante = 10) {
            if (gameState.credits < ante) {
                addToLog(`<p class="text-red-400">You need at least ${ante} credits to play this table.</p>`)
                return;
            }
            gameState.credits -= ante;
            
            gameState.modal = {
                type: 'sabacc',
                context: {
                    ante: ante,
                    pot: ante * 2, // Dealer matches
                    playerHand: [drawSabaccCard(), drawSabaccCard()],
                    dealerHand: [drawSabaccCard(), drawSabaccCard()],
                    message: "Place your bet.",
                    phase: 'betting' // betting, playing, end
                }
            };
            renderSabaccModal();
        }
        
        function drawSabaccCard() {
            return Math.floor(Math.random() * 21) - 10; // -10 to 10
        }

        function calculateSabaccHand(hand) {
            return hand.reduce((sum, card) => sum + card, 0);
        }
        
        function dealerSabaccTurn() {
            const context = gameState.modal.context;
            let dealerScore = calculateSabaccHand(context.dealerHand);
            while (dealerScore < 17 && dealerScore < calculateSabaccHand(context.playerHand)) {
                context.dealerHand.push(drawSabaccCard());
                dealerScore = calculateSabaccHand(context.dealerHand);
            }
            
            const playerScore = calculateSabaccHand(context.playerHand);
            let endMessage = '';
            
            if (dealerScore > 23 || (playerScore <= 23 && dealerScore < playerScore)) {
                endMessage = `You win! You won ${context.pot} credits.`;
                gameState.credits += context.pot;
            } else if (dealerScore > playerScore) {
                endMessage = `Dealer wins with ${dealerScore}.`;
            } else {
                endMessage = `It's a push! You get your ante back.`;
                gameState.credits += context.ante;
            }
            
            endSabaccRound(endMessage);
        }

        function endSabaccRound(message) {
            gameState.modal.context.message = message;
            gameState.modal.context.phase = 'end';
            renderSabaccModal();
        }

        // --- GAME START & CHARACTER CREATION ---
        async function startNewGameWithSettings(useAi, apiKey = null) {
            clearInterval(tipInterval);
            gameState.settings = { useAiImages: useAi };
            if (useAi) {
                ai = new GoogleGenAI({ apiKey: apiKey });
                
                // Show preloading screen
                gameState.screen = 'preloading';
                render();

                // Wait for all images to be generated
                await generateCutsceneImages();

                // Now start the cutscene
                gameState.screen = 'cutscene';
                gameState.cutscene = { index: 0 };
                render();

            } else {
                ai = null;
                // Offline mode, no preloading needed
                gameState.screen = 'cutscene';
                gameState.cutscene = { index: 0 };
                render(); 
            }
        }

        function initCharacter() {
            const currentSettings = gameState.settings;
             gameState = {
                screen: 'creator',
                time: 'day',
                settings: currentSettings,
                character: {
                    name: `${getRandomElement(nameData.first)} ${getRandomElement(nameData.last)}`,
                    level: 1,
                    xp: 0,
                    xpToNextLevel: 1000,
                    attributePoints: 0,
                    race: 'human',
                    characterClass: 'scoundrel',
                    subclass: 'gunslinger',
                    background: 'wasteland_scavenger',
                    faction: 'hutt_cartel',
                    stats: { S: 5, P: 5, E: 5, C: 5, I: 5, A: 5, L: 5 },
                    hp: 0,
                    maxHp: 0,
                    equipped: { weapon: null, armor: null, gear: null },
                },
                creator: {
                    step: 'identity', // 'identity', 'details', 'special'
                    points: 5,
                    statBonuses: {}
                },
                locationId: 'mos_eisley_cantina',
                credits: 100,
                inventory: [ { id: 'datapad', quantity: 1 } ],
                quests: { 'the_ghost_in_the_machine': { id: 'the_ghost_in_the_machine', stage: 0, completed: false } },
                companions: [],
                flags: {},
                log: [],
                holonetNews: ['market_report'],
                ui: { 
                    activeTab: 'inventory', 
                    locationImages: {}, 
                    npcPortraits: {}, 
                    isTyping: false, 
                    availableActions: [],
                    justMoved: false,
                    selectedInventoryId: null,
                    selectedQuestId: null,
                    selectedCompanionId: null,
                },
                modal: null
            };
            render();
        }

        function renderWelcomeScreen(container) {
            container.innerHTML = `
                <div class="flex flex-col items-center justify-center h-full bg-gray-900">
                    <div class="bg-gray-800 p-10 rounded-lg text-center animate-fade-in max-w-3xl w-full border-2 border-gray-700">
                        <h1 class="text-4xl font-title text-yellow-400 mb-4">Welcome to The Outer Rim</h1>
                        <p class="text-lg text-gray-300 mb-6">
                            You are about to embark on a text-based role-playing adventure set in the vast Star Wars universe. Your choices will shape your story.
                        </p>
                        <p class="text-md text-gray-400 mb-8">
                            This game uses generative AI to create dynamic visuals for locations and characters, enhancing your immersion. The next step will guide you through setting up this feature.
                        </p>
                        <p class="text-sm text-gray-400 italic mt-8 mb-8">"For my Brother Christian, The most loyal Jedi I have ever known"</p>
                        <button id="welcome-continue-btn" class="game-button bg-amber-600 hover:bg-amber-500 text-white font-bold py-3 px-10 rounded text-lg">Continue</button>
                    </div>
                </div>
            `;
            document.getElementById('welcome-continue-btn').addEventListener('click', () => {
                gameState.screen = 'api_key';
                render();
            });
        }
        
        function renderApiKeyScreen(container) {
            container.innerHTML = `
                <div class="flex flex-col items-center justify-center h-full bg-gray-900">
                    <div class="bg-gray-800 p-10 rounded-lg text-center animate-fade-in max-w-2xl w-full border-2 border-gray-700">
                        <h1 class="text-4xl font-title text-yellow-400 mb-4">API Key Setup</h1>
                        <p class="text-lg text-gray-300 mb-6">
                            This game uses Gemini for image generation. Choose an option below to continue.
                        </p>

                        <div class="bg-gray-900 p-4 rounded-lg mb-6 text-left">
                            <h2 class="text-xl font-bold text-cyan-400 mb-2">Option 1: Use AI Studio (Recommended)</h2>
                            <p class="text-sm text-gray-400 mb-3">Select a key from your Google AI Studio projects.</p>
                            <button id="select-key-btn" class="game-button bg-amber-600 hover:bg-amber-500 text-white font-bold py-2 px-6 rounded">Select API Key via AI Studio</button>
                        </div>

                        <div class="bg-gray-900 p-4 rounded-lg mb-6 text-left">
                            <h2 class="text-xl font-bold text-cyan-400 mb-2">Option 2: Manual Entry</h2>
                            <p class="text-sm text-gray-400 mb-3">Paste your Gemini API key below. This will be saved in your browser.</p>
                            <div class="flex gap-2">
                                <input id="manual-api-key-input" type="password" placeholder="Enter your API key here" class="flex-grow bg-gray-700 border border-gray-600 rounded p-2 text-white placeholder-gray-500 focus:outline-none focus:border-amber-500 focus:ring-1 focus:ring-amber-500">
                                <button id="manual-key-submit-btn" class="game-button bg-green-600 hover:bg-green-500 text-white font-bold py-2 px-4 rounded">Continue</button>
                            </div>
                        </div>
                        
                        <div class="border-t border-gray-600 pt-4 mt-6 text-left">
                             <h2 class="text-xl font-bold text-gray-400 mb-2">Option 3: No AI</h2>
                             <p class="text-sm text-gray-400 mb-3">Play the game without generative images. This will disable visual scene generation.</p>
                            <button id="offline-btn" class="game-button bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-6 rounded">Continue Offline</button>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('select-key-btn').addEventListener('click', async () => {
                await window.aistudio.openSelectKey();
                await startNewGameWithSettings(true, process.env.API_KEY);
            });
            document.getElementById('manual-key-submit-btn').addEventListener('click', async (e) => {
                const button = e.currentTarget;
                const key = document.getElementById('manual-api-key-input').value.trim();
                if (!key) {
                    alert("Please enter a valid API key.");
                    return;
                }

                button.textContent = "Verifying...";
                button.disabled = true;

                try {
                    // Test the key with a simple, non-image call
                    const testAi = new GoogleGenAI({ apiKey: key });
                    await testAi.models.generateContent({model: 'gemini-2.5-flash', contents: 'test'});
                    
                    // If successful, save and proceed
                    localStorage.setItem('outerRimApiKey', key);
                    await startNewGameWithSettings(true, key);

                } catch (error) {
                    console.error("API Key validation failed:", error);
                    alert("The provided API Key is invalid or has an issue. Please check the key and try again.");
                    button.textContent = "Continue";
                    button.disabled = false;
                }
            });
            document.getElementById('offline-btn').addEventListener('click', () => {
                startNewGameWithSettings(false);
            });
        }

        function renderMainMenu(container) {
             container.innerHTML = `
                <div class="flex flex-col items-center justify-center h-full bg-cover bg-center relative" style="background-image: url('https://storage.googleapis.com/aistudio-public/projects/meet-gemini/2-24/convo-background-3.jpg');">
                    <div class="bg-black bg-opacity-60 p-10 rounded-lg text-center animate-fade-in">
                        <h1 class="text-6xl font-title text-yellow-400 mb-2">The Outer Rim</h1>
                        <p class="text-xl font-title text-gray-300 mb-8">A Star Wars Story</p>
                        <div class="space-y-4">
                            <button id="new-game-btn" class="game-button bg-amber-600 hover:bg-amber-500 text-white font-bold py-3 px-10 rounded text-lg">New Game</button>
                            <button id="load-game-menu-btn" class="game-button bg-gray-600 hover:bg-gray-500 text-white font-bold py-3 px-10 rounded text-lg">Load Game</button>
                        </div>
                    </div>
                    <p class="absolute bottom-4 text-gray-500 text-sm">Sparks Software</p>
                </div>
            `;
            document.getElementById('new-game-btn').addEventListener('click', () => {
                gameState.screen = 'welcome';
                render();
            });
            document.getElementById('load-game-menu-btn').addEventListener('click', loadGame);
        }
        
        async function generateImage(prompt) {
             const useAi = gameState.settings?.useAiImages ?? true;
             if (!ai || !useAi) {
                console.log("Skipping image generation (AI disabled or not initialized).");
                return null;
            }
            try {
                const response = await ai.models.generateContent({
                    model: 'gemini-2.5-flash-image',
                    contents: [{ parts: [{ text: prompt }] }],
                    config: { responseModalities: [Modality.IMAGE] },
                });
                for (const part of response.candidates[0].content.parts) {
                    if (part.inlineData) {
                        return `data:image/png;base64,${part.inlineData.data}`;
                    }
                }
            } catch (error) {
                console.error("Error generating image:", error);
                return null;
            }
            return null;
        }

        async function generateCutsceneImages() {
            const useAi = gameState.settings?.useAiImages ?? true;
            if (!ai || !useAi) return;

            // Use a sequential for...of loop to avoid rate limiting
            for (const [index, slide] of cutscene.entries()) {
                if (!slide.imageUrl) {
                    const url = await generateImage(slide.imagePrompt);
                    if (url) {
                        cutscene[index].imageUrl = url;
                    }
                    // Wait for 1 second before the next request to respect API limits
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }
            }
            console.log("All cutscene images have been pre-loaded sequentially.");
        }
        
        async function generateLocationImage(locationId) {
            const imageKey = `${locationId}_${gameState.time}`;
            const useAi = gameState.settings?.useAiImages ?? true;
            if (!ai || !useAi || gameState.ui.locationImages[imageKey]) return;

            const location = locations[locationId];
            const description = (gameState.time === 'night' && location.description_night) ? location.description_night : location.description;
            const prompt = `A highly detailed, cinematic, atmospheric digital painting in the style of Star Wars, depicting: ${description}. It is currently ${gameState.time}.`;
            const imageUrl = await generateImage(prompt);
            
            if(imageUrl) {
                gameState.ui.locationImages[imageKey] = imageUrl;
                if(gameState.locationId === locationId) {
                    renderImageBox();
                }
            }
        }
        
        async function generateNpcPortrait(npcId) {
            const useAi = gameState.settings?.useAiImages ?? true;
            if (!ai || !useAi || gameState.ui.npcPortraits[npcId]) return;

            const npc = npcs[npcId];
            const detailedPrompt = npc.portraitPrompt || `Head and shoulders portrait of a Star Wars character: ${npc.description}. Cinematic, character concept art, detailed, dramatic lighting.`;
            const imageUrl = await generateImage(detailedPrompt);

            if(imageUrl) {
                gameState.ui.npcPortraits[npcId] = imageUrl;
                if(gameState.modal && gameState.modal.type === 'dialogue' && gameState.modal.context.npcId === npcId) {
                    renderDialogueModal();
                }
            }
        }

        function renderPreloadingScreen(container) {
            clearInterval(tipInterval); // Clear any previous interval

            container.innerHTML = `
                <div class="flex flex-col items-center justify-center h-full bg-cover bg-center relative" style="background-image: url('https://storage.googleapis.com/aistudio-public/projects/meet-gemini/2-24/convo-background-3.jpg');">
                    <div class="bg-black bg-opacity-70 p-10 rounded-lg text-center animate-fade-in max-w-2xl">
                        <div class="spinner mx-auto mb-4"></div>
                        <h2 class="text-3xl font-title text-yellow-400">Preparing Your Journey...</h2>
                        <p class="text-gray-300 mt-2 mb-6">Generating cinematic intro sequences. Please wait.</p>
                        <div class="border-t border-gray-600 pt-4 mt-4">
                            <p class="text-amber-400 font-bold text-sm">TIP:</p>
                            <p id="game-tip" class="text-gray-300 italic min-h-[40px]"></p>
                        </div>
                    </div>
                </div>
            `;
            
            const tipElement = document.getElementById('game-tip');
            const showRandomTip = () => {
                tipElement.textContent = getRandomElement(gameTips);
            };

            showRandomTip();
            tipInterval = setInterval(showRandomTip, 4000);
        }

        function renderCutscene() {
            const root = document.getElementById('root');
            const { index } = gameState.cutscene;
            const slide = cutscene[index];
            const useAi = gameState.settings?.useAiImages ?? true;

            let imageContent = '';
            if (slide.imageUrl) {
                imageContent = `<img src="${slide.imageUrl}" class="absolute inset-0 w-full h-full object-cover animate-fade-in" />`;
            } else if (useAi) {
                imageContent = `<div class="absolute inset-0 flex items-center justify-center"><div class="spinner"></div></div>`;
            } else {
                imageContent = `<div class="absolute inset-0 bg-black"></div>`;
            }

            let mainContent = '';
            if (slide.isTitleSlide) {
                mainContent = `
                    <div class="relative z-10 p-8 text-center cutscene-text-fade">
                        <h1 class="text-6xl font-title text-yellow-400 mb-2 title-outline">The Outer Rim</h1>
                        <p class="text-xl font-title text-gray-300 title-outline">A Star Wars Story</p>
                    </div>
                `;
            } else {
                 mainContent = `
                    <div class="relative z-10 p-8 max-w-4xl text-center bg-black bg-opacity-50 rounded-lg cutscene-text-fade">
                        <p class="text-2xl leading-relaxed">${slide.text}</p>
                    </div>
                `;
            }

            root.innerHTML = `
                <div class="flex items-center justify-center h-full relative text-white bg-black">
                    ${imageContent}
                    ${mainContent}
                     <button id="cutscene-next" class="absolute bottom-10 right-10 game-button bg-amber-600 hover:bg-amber-500 text-white font-bold py-2 px-6 rounded">
                        ${index === cutscene.length - 1 ? 'Begin' : 'Next'} &raquo;
                     </button>
                </div>
            `;

            document.getElementById('cutscene-next').addEventListener('click', () => {
                if (index < cutscene.length - 1) {
                    gameState.cutscene.index++;
                    render();
                } else {
                    initCharacter();
                }
            });
        }
        
        function renderCreator(container) {
            let shell = document.getElementById('creator-shell');
            // If the shell doesn't exist, create it.
            if (!shell) {
                container.innerHTML = `
                    <div id="creator-shell" class="min-h-screen w-screen flex items-center justify-center p-4 bg-cover bg-center" style="background-image: url('https://storage.googleapis.com/aistudio-public/projects/meet-gemini/2-24/convo-background-3.jpg');">
                        <div id="creator-content" class="bg-gray-900 bg-opacity-90 p-6 md:p-8 rounded-xl shadow-2xl w-full max-w-7xl overflow-y-auto custom-scrollbar" style="max-height: 95vh;">
                            <!-- Step content will be injected here -->
                        </div>
                    </div>
                `;
            }

            const contentContainer = document.getElementById('creator-content');
            
            const step = gameState.creator.step;
            
            // Only re-apply animation if the step is changing.
            if (contentContainer.dataset.step !== step) {
                 contentContainer.classList.remove('animate-fade-in');
                 void contentContainer.offsetWidth; // Force browser reflow to restart the animation
                 contentContainer.classList.add('animate-fade-in');
                 contentContainer.dataset.step = step;
            }
            
            // Call the appropriate function to render the content for the current step
            switch(step) {
                case 'identity':
                    renderCreatorIdentityStep(contentContainer);
                    break;
                case 'details':
                    renderCreatorDetailsStep(contentContainer);
                    break;
                case 'special':
                    renderCreatorSpecialStep(contentContainer);
                    break;
            }
            // Re-attach event listeners to the new content
            attachCreatorListeners();
        }


        function renderChoiceBox(group, key, options, selectedKey) {
            const option = options[key];
            const isSelected = key === selectedKey;
            let bonusHtml = '';

            if (option.bonus) { // For races, backgrounds, subclasses
                if (option.bonus.type === 'stat') {
                    bonusHtml = `<p class="font-bold text-green-400">${specialNames[option.bonus.stat]} +${option.bonus.value}</p>`;
                } else if (option.bonus.type === 'credits') {
                    bonusHtml = `<p class="font-bold text-yellow-400">+${option.bonus.value} Credits</p>`;
                } else { // Generic stat bonus object for subclasses
                    bonusHtml = Object.entries(option.bonus).map(([stat, val]) => 
                        `<p class="font-bold text-green-400">${specialNames[stat] || stat.charAt(0).toUpperCase() + stat.slice(1)} +${val}</p>`
                    ).join('');
                }
            } else if (option.statBonuses) { // For classes
                bonusHtml = Object.entries(option.statBonuses).map(([stat, val]) => 
                    `<p class="font-bold text-green-400">${specialNames[stat]} +${val}</p>`
                ).join('');
            } else if (option.bonus_desc) { // for factions
                bonusHtml = `<p class="font-bold text-cyan-400 text-xs">${option.bonus_desc}</p>`;
            }
            
            return `
                <div class="creator-choice-box ${isSelected ? 'selected' : ''}" data-group="${group}" data-key="${key}">
                    <h3 class="text-lg font-bold text-amber-400">${option.name}</h3>
                    <p class="text-xs text-gray-400 mt-1 mb-2 flex-grow">${option.description}</p>
                    <div class="bonus-display">${bonusHtml}</div>
                </div>
            `;
        }
        
        function renderCreatorIdentityStep(container) {
            const { name, race, characterClass } = gameState.character;
            container.innerHTML = `
                <h1 class="text-4xl text-center font-title text-amber-400 mb-2">Character Creation: Identity</h1>
                <p class="text-center text-gray-400 mb-6">Choose your core identity.</p>

                <div class="mb-6">
                    <label class="block text-xl font-bold text-cyan-400 mb-2">Name:</label>
                    <input id="char-name" type="text" value="${name}" class="w-full bg-gray-800 p-2 rounded text-white border-2 border-gray-700 focus:border-amber-500 focus:outline-none text-lg">
                </div>
                
                <div>
                    <h2 class="text-xl font-bold text-cyan-400 mb-3">Race:</h2>
                    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4">
                        ${Object.keys(races).map(key => renderChoiceBox('race', key, races, race)).join('')}
                    </div>
                </div>
                
                <div class="mt-6">
                    <h2 class="text-xl font-bold text-cyan-400 mb-3">Class:</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            ${Object.keys(classes).map(key => renderChoiceBox('characterClass', key, classes, characterClass)).join('')}
                    </div>
                </div>

                <div class="mt-8 text-center">
                    <button id="creator-next-btn" class="game-button bg-green-600 hover:bg-green-500 text-white font-bold py-3 px-12 rounded text-lg">Next &raquo;</button>
                </div>
            `;
        }

        function renderCreatorDetailsStep(container) {
             const { background, subclass, faction, characterClass } = gameState.character;
             container.innerHTML = `
                <h1 class="text-4xl text-center font-title text-amber-400 mb-2">Character Creation: Details</h1>
                <p class="text-center text-gray-400 mb-6">Define your past and specialization.</p>

                    <div>
                    <h2 class="text-xl font-bold text-cyan-400 mb-3">Background:</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        ${Object.keys(backgrounds).map(key => renderChoiceBox('background', key, backgrounds, background)).join('')}
                    </div>
                </div>

                <div class="mt-6">
                    <h2 class="text-xl font-bold text-cyan-400 mb-3">Subclass:</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        ${Object.keys(subclasses[characterClass]).map(key => renderChoiceBox('subclass', key, subclasses[characterClass], subclass)).join('')}
                    </div>
                </div>
                
                <div class="mt-6">
                    <h2 class="text-xl font-bold text-cyan-400 mb-3">Faction Affiliation:</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            ${Object.keys(factions).map(key => renderChoiceBox('faction', key, factions, faction)).join('')}
                    </div>
                </div>

                <div class="mt-8 flex justify-between">
                    <button id="creator-back-btn" class="game-button bg-gray-600 hover:bg-gray-500 text-white font-bold py-3 px-12 rounded text-lg">&laquo; Back</button>
                    <button id="creator-next-btn" class="game-button bg-green-600 hover:bg-green-500 text-white font-bold py-3 px-12 rounded text-lg">Next &raquo;</button>
                </div>
            `;
        }

        function renderCreatorSpecialStep(container) {
            const { stats } = gameState.character;
            const { points } = gameState.creator;
            updateCharacterBonuses(); // Ensure bonuses are calculated
            const bonuses = gameState.creator.statBonuses;

            const renderStatAllocator = (stat, value) => {
                const bonus = bonuses[stat] || 0;
                const finalValue = value + bonus;
                return `
                    <div class="flex items-center justify-between p-2 bg-gray-900 rounded">
                        <span class="font-bold w-1/3 text-lg">${specialNames[stat]}</span>
                        <div class="flex items-center gap-3">
                            <button class="stat-btn bg-red-600 hover:bg-red-500 w-8 h-8 rounded-full font-bold text-xl" data-stat="${stat}" data-mod="-1">-</button>
                            <span id="stat-val-${stat}" class="font-bold text-xl w-8 text-center">${value}</span>
                            <button class="stat-btn bg-green-600 hover:bg-green-500 w-8 h-8 rounded-full font-bold text-xl" data-stat="${stat}" data-mod="1">+</button>
                        </div>
                        <div class="w-1/3 text-right">
                            ${bonus > 0 ? `<span class="text-green-400 text-sm">(+${bonus})</span>` : ''}
                            <span id="final-stat-${stat}" class="font-bold text-xl text-amber-300 ml-2">${finalValue}</span>
                        </div>
                    </div>
                `;
            };
            
            container.innerHTML = `
                <h1 class="text-4xl text-center font-title text-amber-400 mb-2">Character Creation: Attributes</h1>
                <p class="text-center text-gray-400 mb-6">Assign your S.P.E.C.I.A.L. points.</p>
                
                <div class="bg-gray-800 p-6 rounded-lg">
                    <p class="text-center mb-4">Points Remaining: <span id="points-remaining" class="font-bold text-3xl text-yellow-300">${points}</span></p>
                    <div id="stat-allocation" class="space-y-3">
                        ${AllStats.map(stat => renderStatAllocator(stat, stats[stat])).join('')}
                    </div>
                </div>

                <div class="mt-8 flex justify-between">
                    <button id="creator-back-btn" class="game-button bg-gray-600 hover:bg-gray-500 text-white font-bold py-3 px-12 rounded text-lg">&laquo; Back</button>
                    <button id="finalize-char" class="game-button bg-green-600 hover:bg-green-500 text-white font-bold py-3 px-12 rounded text-lg">Finalize Character</button>
                </div>
            `;
        }

        function renderLevelUpScreen(container) {
            const { tempStats, pointsToSpend, originalPoints } = gameState.levelUpState;

            const renderStatAllocator = (stat) => {
                const baseValue = gameState.character.stats[stat];
                const newValue = tempStats[stat];
                return `
                    <div class="flex items-center justify-between p-2 bg-gray-900 rounded">
                        <span class="font-bold w-1/3 text-lg">${specialNames[stat]}</span>
                        <div class="flex items-center gap-3">
                             <span class="font-bold text-xl w-8 text-center">${baseValue}</span>
                             <span class="text-gray-400">&rarr;</span>
                            <span id="stat-val-${stat}" class="font-bold text-xl w-8 text-center text-amber-300">${newValue}</span>
                            <button class="stat-btn bg-green-600 hover:bg-green-500 w-8 h-8 rounded-full font-bold text-xl" data-stat="${stat}" data-mod="1">+</button>
                        </div>
                    </div>
                `;
            };
            
            container.innerHTML = `
                <div class="min-h-screen w-screen flex items-center justify-center p-4 bg-cover bg-center" style="background-image: url('https://storage.googleapis.com/aistudio-public/projects/meet-gemini/2-24/convo-background-3.jpg');">
                    <div class="bg-gray-900 bg-opacity-90 p-8 rounded-xl shadow-2xl w-full max-w-2xl animate-fade-in">
                        <h1 class="text-4xl text-center font-title text-amber-400 mb-2">Level Up!</h1>
                        <p class="text-center text-gray-400 mb-6">You are now Level ${gameState.character.level}. Spend your attribute point.</p>
                        
                        <div class="bg-gray-800 p-6 rounded-lg">
                            <p class="text-center mb-4">Points Remaining: <span id="points-remaining" class="font-bold text-3xl text-yellow-300">${pointsToSpend}</span></p>
                            <div id="stat-allocation" class="space-y-3">
                                ${AllStats.map(stat => renderStatAllocator(stat)).join('')}
                            </div>
                        </div>

                        <div class="mt-8 text-center">
                            <button id="finalize-levelup" class="game-button bg-green-600 hover:bg-green-500 text-white font-bold py-3 px-12 rounded text-lg" ${pointsToSpend > 0 ? 'disabled' : ''}>
                                Confirm
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            // Attach listeners specifically for this screen
            document.querySelectorAll('.stat-btn').forEach(btn => {
                btn.addEventListener('click', e => {
                    const { stat } = e.currentTarget.dataset;
                    if (gameState.levelUpState.pointsToSpend > 0) {
                        gameState.levelUpState.tempStats[stat]++;
                        gameState.levelUpState.pointsToSpend--;
                        renderLevelUpScreen(container); // Re-render this component
                    }
                });
            });

            document.getElementById('finalize-levelup').addEventListener('click', () => {
                if (gameState.levelUpState.pointsToSpend === 0) {
                    gameState.character.stats = { ...gameState.levelUpState.tempStats };
                    gameState.character.attributePoints = 0;
                    
                    // Recalculate derived stats
                    const oldMaxHp = gameState.character.maxHp;
                    const newMaxHp = calculateMaxHP(getPlayerStat('E'));
                    const hpDiff = newMaxHp - oldMaxHp;
                    if (hpDiff > 0) {
                        gameState.character.maxHp = newMaxHp;
                        gameState.character.hp += hpDiff; // Add the bonus to current HP as well
                    }

                    delete gameState.levelUpState;
                    gameState.screen = 'game';
                    render();
                }
            });
        }
        
        function updateCharacterBonuses() {
             const char = gameState.character;
             const bonuses = {};
             AllStats.forEach(s => bonuses[s] = 0);

             // Race
             const raceBonus = races[char.race].bonus;
             bonuses[Object.keys(raceBonus)[0]] += Object.values(raceBonus)[0];
             // Class
             Object.entries(classes[char.characterClass].statBonuses).forEach(([stat, val]) => bonuses[stat] += val);
             // Background
             const bgBonus = backgrounds[char.background].bonus;
             if (bgBonus.type === 'stat') bonuses[bgBonus.stat] += bgBonus.value;
             // Subclass
             const subBonus = subclasses[char.characterClass][char.subclass].bonus;
             bonuses[Object.keys(subBonus)[0]] += Object.values(subBonus)[0];

             gameState.creator.statBonuses = bonuses;
        }

        function updateSpecialUI() {
            const { stats } = gameState.character;
            const { points, statBonuses } = gameState.creator;

            document.getElementById('points-remaining').textContent = points;

            AllStats.forEach(stat => {
                document.getElementById(`stat-val-${stat}`).textContent = stats[stat];
                const finalValue = stats[stat] + (statBonuses[stat] || 0);
                document.getElementById(`final-stat-${stat}`).textContent = finalValue;
            });
        }


        function attachCreatorListeners() {
            // Name Input
            document.getElementById('char-name')?.addEventListener('change', e => gameState.character.name = e.target.value);
            
            // Choice Boxes
            document.querySelectorAll('.creator-choice-box').forEach(box => {
                box.addEventListener('click', e => {
                    const { group, key } = e.currentTarget.dataset;
                    
                    gameState.character[group] = key;
                    
                    // If class changes, reset subclass to the first available one
                    if (group === 'characterClass') {
                       gameState.character.subclass = Object.keys(subclasses[key])[0];
                    }
                    render(); // Re-render to show selection and update any dependent fields
                });
            });

            // Stat Buttons
            document.querySelectorAll('.stat-btn').forEach(btn => {
                btn.addEventListener('click', e => {
                    const { stat, mod } = e.currentTarget.dataset;
                    const points = gameState.creator.points;
                    const statVal = gameState.character.stats[stat];
                    const change = parseInt(mod);

                    if (change > 0 && points > 0 && statVal < 10) {
                        gameState.character.stats[stat]++;
                        gameState.creator.points--;
                    } else if (change < 0 && statVal > 1) {
                         gameState.character.stats[stat]--;
                         gameState.creator.points++;
                    }
                    updateSpecialUI();
                });
            });

            // Navigation Buttons
            document.getElementById('creator-next-btn')?.addEventListener('click', () => {
                const currentStep = gameState.creator.step;
                if (currentStep === 'identity') gameState.creator.step = 'details';
                else if (currentStep === 'details') gameState.creator.step = 'special';
                render();
            });
            document.getElementById('creator-back-btn')?.addEventListener('click', () => {
                const currentStep = gameState.creator.step;
                if (currentStep === 'special') gameState.creator.step = 'details';
                else if (currentStep === 'details') gameState.creator.step = 'identity';
                render();
            });

            // Finalize Button
            document.getElementById('finalize-char')?.addEventListener('click', () => {
                // Apply all final calculations
                const finalCharacter = gameState.character;
                updateCharacterBonuses();
                const bonuses = gameState.creator.statBonuses;
                AllStats.forEach(s => finalCharacter.stats[s] += bonuses[s]);
                
                const bgBonus = backgrounds[finalCharacter.background].bonus;
                if (bgBonus.type === 'credits') gameState.credits += bgBonus.value;

                finalCharacter.maxHp = calculateMaxHP(finalCharacter.stats.E);
                finalCharacter.hp = finalCharacter.maxHp;

                // Add starting item
                const startItem = classes[finalCharacter.characterClass].startItem;
                addItemToInventory(startItem);
                
                // Switch to game screen
                gameState.screen = 'game';
                gameState.ui.justMoved = true;
                delete gameState.creator; // No longer needed
                render();
            });
        }
        
        // --- TEXT & LOG HELPERS ---
        function addToLog(htmlString) {
            gameState.log.push(htmlString);
            if (gameState.log.length > 100) {
                gameState.log.shift();
            }
            const logHistory = document.getElementById('log-history');
            if(logHistory){
                logHistory.innerHTML += htmlString;
                logHistory.scrollTop = logHistory.scrollHeight;
            }
        }

        function displayCurrentLocation() {
            const location = locations[gameState.locationId];
            if (!location) return;

            let locationData = { ...location };
            if (gameState.locationId === 'player_safehouse_garage') {
                const firstName = gameState.character.name.split(' ')[0];
                const possessiveFirstName = firstName.endsWith('s') ? `${firstName}'` : `${firstName}'s`;
                locationData.name = `${possessiveFirstName} Hideout`;
            } else if (gameState.locationId === 'player_safehouse_interior') {
                locationData.name = "Hideout Living Quarters";
            }

            gameState.ui.availableActions = [];
            const logHistory = document.getElementById('log-history');
            if (!logHistory) return;

            const entryContainer = document.createElement('div');
            entryContainer.className = 'location-entry mb-4';
            
            const descriptionPart = `
                <div class="pb-2 border-b border-gray-700">
                    <h1 class="text-3xl font-bold text-amber-400 font-title">${locationData.name}</h1>
                    <div class="location-description mt-2 text-yellow-400"></div>
                </div>
            `;
            const actionsPart = `<div class="available-actions-container"></div>`;
            entryContainer.innerHTML = descriptionPart + actionsPart;
            logHistory.appendChild(entryContainer);

            const descriptionEl = entryContainer.querySelector('.location-description');
            const actionsContainerEl = entryContainer.querySelector('.available-actions-container');

            const description = (gameState.time === 'night' && location.description_night) ? location.description_night : location.description;

            typeText(descriptionEl, description, () => {
                displayAvailableActions(actionsContainerEl);
                gameState.log.push(entryContainer.outerHTML);
                if (gameState.log.length > 100) gameState.log.shift();
            });
        }
        
        function displayAvailableActions(container) {
            const location = locations[gameState.locationId];
            if (!location || !container) return;
            
            gameState.ui.availableActions = [];
            let actionsHtml = `<div class="mt-4"><p class="font-bold text-cyan-300">Available Actions:</p><ul class="list-disc list-inside text-sm">`;

            // Standard actions
            location.actions.forEach(action => {
                let actionText = action.name;
                if (action.action?.type === 'rest') {
                    const nextTime = gameState.time === 'day' ? 'night' : 'morning';
                    actionText = `Rest until ${nextTime}`;
                }
                gameState.ui.availableActions.push({ text: actionText, action: action });
                actionsHtml += `<li class="text-gray-300">${actionText}</li>`;
            });

            // Time-sensitive actions
            if (location.timeSensitiveActions) {
                location.timeSensitiveActions.forEach(action => {
                    if (action.time === gameState.time) {
                        gameState.ui.availableActions.push({ text: action.name, action: action });
                        actionsHtml += `<li class="text-gray-300">${action.name}</li>`;
                    }
                });
            }

            // Quest-based actions
            if (location.questActions) {
                location.questActions.forEach(qa => {
                    const questState = gameState.quests[qa.questId];
                    if (questState && questState.stage === qa.stage && !questState.completed && (!qa.class || qa.class === gameState.character.characterClass)) {
                        gameState.ui.availableActions.push({ text: qa.action.name, action: qa.action });
                        actionsHtml += `<li class="text-gray-300">${qa.action.name}</li>`;
                    }
                });
            }

            // Conditional actions
            if (location.conditionalActions) {
                location.conditionalActions.forEach(ca => {
                    let allConditionsMet = true;
                    ca.conditions.forEach(cond => {
                        switch (cond.type) {
                            case 'class':
                                if (gameState.character.characterClass !== cond.value) allConditionsMet = false;
                                break;
                            case 'quest_completed':
                                if (!gameState.quests[cond.questId]?.completed) allConditionsMet = false;
                                break;
                            case 'quest_not_started':
                                if (gameState.quests[cond.questId]) allConditionsMet = false;
                                break;
                            case 'flag_is_true':
                                if (!gameState.flags[cond.flag]) allConditionsMet = false;
                                break;
                            case 'flag_is_not_set':
                                if (gameState.flags[cond.flag]) allConditionsMet = false;
                                break;
                             case 'quest_is_active':
                                if (!gameState.quests[cond.questId] || gameState.quests[cond.questId].completed) allConditionsMet = false;
                                break;
                        }
                    });

                    if (allConditionsMet) {
                        gameState.ui.availableActions.push({ text: ca.action.name, action: ca.action.action });
                        actionsHtml += `<li class="text-yellow-300 font-bold">${ca.action.name}</li>`;
                    }
                });
            }

            // "Talk to" actions generated from the NPC list
            if (location.npcs) {
                location.npcs.forEach(npcId => {
                    const npc = npcs[npcId];
                    if (npc) {
                        const actionText = `Talk to ${npc.name}`;
                        gameState.ui.availableActions.push({ text: actionText, action: { type: 'talk', npcId: npc.id } });
                        actionsHtml += `<li class="text-gray-300">${actionText}</li>`;
                    }
                });
            }

            actionsHtml += `</ul></div>`;
            container.innerHTML = actionsHtml;
            
            const logHistory = document.getElementById('log-history');
            if (logHistory) {
              logHistory.scrollTop = logHistory.scrollHeight;
            }
        }

        function displayHelp() {
            let helpText = `
                <div class="my-2">
                    <p class="font-bold text-cyan-300">Generic Commands:</p>
                    <ul class="list-disc list-inside text-sm">
                        <li><b>look</b>: Describe the current area and list actions again.</li>
                        <li><b>save</b>: Save your progress (in browser).</li>
                        <li><b>clear</b>: Clear the log screen.</li>
                        <li><b>help</b>: Show this message.</li>
                    </ul>
                    <p class="mt-2 text-gray-400">For all other actions like moving, talking, or trading, type the action as naturally as possible (e.g., 'talk to wuher', 'go cantina', 'buy juice', 'access panel').</p>
                </div>
            `;
            addToLog(helpText);
        }

        async function reinitializeAiFromState() {
            const useAi = gameState.settings?.useAiImages ?? false;
            if (useAi) {
                const hasAiStudioKey = await window.aistudio.hasSelectedApiKey();
                const manualKey = localStorage.getItem('outerRimApiKey');
                let keyToUse = null;

                if (hasAiStudioKey) {
                    keyToUse = process.env.API_KEY;
                } else if (manualKey) {
                    keyToUse = manualKey;
                }
                
                if (keyToUse) {
                    ai = new GoogleGenAI({apiKey: keyToUse});
                } else {
                    console.log("Could not find API key for loaded game. Disabling AI features for this session.");
                    gameState.settings.useAiImages = false;
                    ai = null;
                }
            } else {
                ai = null;
            }
        }

        // --- INITIALIZATION ---
        async function initGame() {
            const embeddedDataEl = document.getElementById('embedded-save-data');
            let loadedFromEmbed = false;
            if (embeddedDataEl && embeddedDataEl.textContent.trim()) {
                try {
                    const savedData = JSON.parse(embeddedDataEl.textContent.trim());
                    if (savedData && savedData.character) {
                        gameState = savedData;
                        loadedFromEmbed = true;
                        console.log("Game loaded from embedded HTML data.");
                    }
                } catch (e) {
                    console.error("Failed to parse embedded save data:", e);
                }
            }

            if (loadedFromEmbed) {
                await reinitializeAiFromState();
                render();
                addToLog('<p class="text-green-400">Game loaded from file.</p>');
            } else {
                if (!gameState.screen) {
                    gameState.screen = 'menu';
                }
                render();
            }

            if (gameState.screen === 'game' && loadedFromEmbed) {
                 const logHistory = document.getElementById('log-history');
                 const actionsContainer = document.createElement('div');
                 logHistory.appendChild(actionsContainer);
                 displayAvailableActions(actionsContainer);
            }
        }

        initGame();
    </script>
<script type="module" src="/index.tsx"></script>
</body>
</html>